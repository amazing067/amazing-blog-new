# 스마트 라우팅 적용 분석 보고서

## 📊 분석 기준 (점수 시스템)

### Gemini가 선택되는 경우:
1. **이미지 분석 작업** (+3점)
   - 이미지 + JSON 추출 (+2점)
2. **한국어 비중 높음** (+2점) - 한국어 비율 30% 이상
3. **간단한 정보 추출** (+2점) - 기본 정보 추출, usePro=false
4. **구조화된 출력** (+1점) - 이미지 + JSON 형식

### GPT가 선택되는 경우:
1. **복잡한 분석/추론** (+2점) - "분석" 키워드 + 프롬프트 1000자 이상
2. **비교/추천/판단** (+1점)
3. **긴 텍스트 생성** (+2점) - "생성/작성/설명" + 프롬프트 2000자 이상
4. **검색 결과 활용** (+1점) - 최신 정보 통합 분석

---

## 1️⃣ 설계서 분석 API (`app/api/analyze-design-sheet/route.ts`)

### 1단계: 기본 정보 추출

**프롬프트 특성:**
- 길이: 약 450자
- 이미지: ✅ 있음
- 한국어 비율: 약 45%
- 키워드: "추출", "JSON", "정보"
- usePro: false

**점수 계산:**
```
Gemini 점수:
  + 이미지 분석 (+3)
  + 이미지 + JSON 추출 (+2)
  + 한국어 비중 높음 (+2)
  + 간단한 정보 추출 (+2)
  = 총 9점

GPT 점수:
  = 총 0점
```

**예상 선택: Gemini ✅**
- 모델: Gemini-2.0-Flash 우선 → 실패 시 Gemini-2.5-Pro
- 폴백: 실패 시 GPT-4o-mini → GPT-4o

**이유:**
- 이미지 분석 + JSON 추출은 Gemini의 강점
- 한국어 비중이 높음
- 간단한 정보 추출 작업

---

### 3단계: 최종 분석

**프롬프트 특성:**
- 길이: 약 1500-2000자 (검색 결과 포함 시)
- 이미지: ✅ 있음
- 한국어 비율: 약 40%
- 키워드: "분석", "검색 결과", "비교", "판단"
- usePro: true

**점수 계산:**
```
Gemini 점수:
  + 이미지 분석 (+3)
  + 이미지 + JSON 추출 (+2)
  + 한국어 비중 높음 (+2)
  = 총 7점

GPT 점수:
  + 복잡한 분석/추론 (+2) - "분석" + 1500자 이상
  + 비교/추천/판단 (+1) - "비교", "판단" 키워드
  + 검색 결과 활용 (+1) - "검색 결과" 키워드
  = 총 4점
```

**예상 선택: Gemini ✅ (7점 > 4점)**
- 모델: Gemini-2.5-Pro 우선 → 실패 시 Gemini-2.0-Flash
- 폴백: 실패 시 GPT-4o → GPT-4o-mini

**이유:**
- 이미지 분석이 핵심
- JSON 구조화 출력 필요
- 한국어 비중 높음
- 하지만 GPT 점수도 높아서 경쟁이 치열함

**⚠️ 주의:**
- 검색 결과가 포함되면 프롬프트가 길어져 GPT 점수가 더 올라갈 수 있음
- 실제로는 **Gemini와 GPT가 비슷한 점수**가 될 가능성 높음
- 이미지가 있으면 Gemini가 약간 유리

---

## 2️⃣ 의료 이미지 분석 API (`app/api/analyze-medical-image/route.ts`)

### 단일 단계: 의료 영수증/병리 보고서 분석

**프롬프트 특성:**
- 길이: 약 6000자 (매우 긴 프롬프트)
- 이미지: ✅ 있음
- 한국어 비율: 약 50%
- 키워드: "분석", "추출", "JSON", "영문", "번역"
- usePro: true (기본값)

**점수 계산:**
```
Gemini 점수:
  + 이미지 분석 (+3)
  + 이미지 + JSON 추출 (+2)
  + 한국어 비중 높음 (+2)
  + 구조화된 출력 (+1) - 이미지 + JSON
  = 총 8점

GPT 점수:
  + 복잡한 분석/추론 (+2) - "분석" + 6000자 (매우 긺)
  + 긴 텍스트 생성 (+2) - 6000자 이상
  = 총 4점
```

**예상 선택: Gemini ✅ (8점 > 4점)**
- 모델: Gemini-2.5-Pro 우선 → 실패 시 Gemini-2.0-Flash
- 폴백: 실패 시 GPT-4o → GPT-4o-mini

**이유:**
- 이미지 분석이 핵심
- 매우 복잡한 JSON 구조화 필요
- 한국어 비중이 매우 높음
- 영문 의료 용어 번역 필요 (Gemini의 한국어 처리 강점)

**⚠️ 주의:**
- 프롬프트가 매우 길어서 GPT 점수가 올라갈 수 있지만
- 이미지 + JSON 추출이 핵심이므로 Gemini가 유리

---

## 3️⃣ Q&A 생성 API (`app/api/generate-qa/route.ts`)

### Step 1: 질문 생성

**프롬프트 특성:**
- 길이: 약 1200-1500자
- 이미지: ❌ 없음 (선택적, designSheetImage가 있을 수 있음)
- 한국어 비율: 약 60-70% (매우 높음)
- 키워드: "생성", "작성", "질문"
- useFlash: true (코드에서 명시)

**점수 계산 (이미지 없는 경우):**
```
Gemini 점수:
  + 한국어 비중 높음 (+2) - 60-70%
  = 총 2점

GPT 점수:
  + 긴 텍스트 생성 (+2) - "생성" + 1500자
  = 총 2점
```

**예상 선택: 동점 → 랜덤 또는 Gemini 우선 (한국어 강점)**

**점수 계산 (이미지 있는 경우):**
```
Gemini 점수:
  + 이미지 분석 (+3)
  + 한국어 비중 높음 (+2)
  = 총 5점

GPT 점수:
  + 긴 텍스트 생성 (+2)
  = 총 2점
```

**예상 선택: Gemini ✅ (이미지 있을 때)**

**실제 코드 동작:**
- 현재 코드는 `useFlash: true`로 고정되어 있음
- 스마트 라우팅 적용 시: **이미지 있으면 Gemini, 없으면 50:50**

---

### Step 2: 답변 생성

**프롬프트 특성:**
- 길이: 약 2000-3000자 (검색 결과 포함 시)
- 이미지: ❌ 없음
- 한국어 비율: 약 60-70%
- 키워드: "생성", "작성", "답변", "검색 결과", "비교"
- useFlash: false (코드에서 명시, Pro 사용)

**점수 계산:**
```
Gemini 점수:
  + 한국어 비중 높음 (+2) - 60-70%
  = 총 2점

GPT 점수:
  + 복잡한 분석/추론 (+2) - "답변" + 3000자
  + 긴 텍스트 생성 (+2) - "생성" + 3000자
  + 검색 결과 활용 (+1) - "검색 결과" 키워드
  + 비교/추천/판단 (+1) - "비교" 키워드
  = 총 6점
```

**예상 선택: GPT ✅ (6점 > 2점)**
- 모델: GPT-4o 우선 → 실패 시 GPT-4o-mini
- 폴백: 실패 시 Gemini-2.5-Pro → Gemini-2.0-Flash

**이유:**
- 검색 결과 통합 분석 필요
- 복잡한 추론 및 비교 작업
- 긴 텍스트 생성
- 한국어는 높지만 GPT의 복잡한 추론 능력이 더 중요

**⚠️ 주의:**
- 한국어 비중이 높아서 Gemini 점수가 올라갈 수 있지만
- 복잡한 분석 작업이므로 GPT가 유리

---

### Step 3: 대화형 스레드 생성

**프롬프트 특성:**
- 길이: 약 800-1200자 (단계별로 다름)
- 이미지: ❌ 없음
- 한국어 비율: 약 70-80% (매우 높음)
- 키워드: "생성", "작성", "댓글", "대화"
- useFlash: true (고객 댓글) / false (설계사 댓글)

**점수 계산 (고객 댓글 - useFlash: true):**
```
Gemini 점수:
  + 한국어 비중 높음 (+2) - 70-80%
  = 총 2점

GPT 점수:
  + 긴 텍스트 생성 (+2) - "생성" + 1200자
  = 총 2점
```

**예상 선택: 동점 → 랜덤 또는 Gemini 우선 (한국어 강점)**

**점수 계산 (설계사 댓글 - useFlash: false):**
```
Gemini 점수:
  + 한국어 비중 높음 (+2)
  = 총 2점

GPT 점수:
  + 긴 텍스트 생성 (+2)
  = 총 2점
```

**예상 선택: 동점 → 랜덤 또는 Gemini 우선**

**이유:**
- 한국어 비중이 매우 높음
- 하지만 복잡한 추론은 필요 없음
- Gemini의 한국어 자연스러움 강점

---

## 📈 전체 예상 분포

### 설계서 분석 API
- **1단계**: Gemini 90% / GPT 10%
- **3단계**: Gemini 60% / GPT 40%

### 의료 이미지 분석 API
- **단일 단계**: Gemini 80% / GPT 20%

### Q&A 생성 API
- **Step 1 (질문)**: Gemini 60% / GPT 40% (이미지 없을 때), Gemini 90% / GPT 10% (이미지 있을 때)
- **Step 2 (답변)**: GPT 70% / Gemini 30%
- **Step 3 (스레드)**: Gemini 60% / GPT 40%

---

## 🎯 최적화 제안

### 1. 점수 가중치 조정
현재 점수 시스템이 이미지 분석에 너무 치우쳐 있음. 다음 조정 고려:

```typescript
// 이미지 분석 작업
if (hasImage) {
  geminiScore += 3  // 현재
  // 제안: +2로 조정 (이미지가 있어도 복잡한 분석은 GPT가 유리할 수 있음)
}

// 복잡한 분석/추론
if (prompt.includes('분석') && prompt.length > 1000) {
  gptScore += 2  // 현재
  // 제안: +3으로 증가 (복잡한 분석은 GPT가 더 강함)
}
```

### 2. 한국어 가중치 조정
한국어 비중이 높을 때 Gemini 점수를 더 올릴 수 있음:

```typescript
// 한국어 특화 작업
const koreanRatio = (prompt.match(/[가-힣]/g) || []).length / prompt.length
if (koreanRatio > 0.3) {
  geminiScore += 2  // 현재
  // 제안: koreanRatio에 따라 가변 점수 (0.3-0.5: +2, 0.5-0.7: +3, 0.7+: +4)
}
```

### 3. 프롬프트 길이 가중치
매우 긴 프롬프트는 GPT가 더 잘 처리할 수 있음:

```typescript
// 프롬프트 길이에 따른 가중치
if (prompt.length > 3000) {
  gptScore += 1  // 추가
}
```

---

## ✅ 결론

1. **이미지 분석 작업**: Gemini가 대부분 선택됨 (이미지 + JSON 추출 강점)
2. **복잡한 텍스트 분석**: GPT가 선택될 가능성 높음 (검색 결과 통합, 복잡한 추론)
3. **한국어 자연스러움**: Gemini가 유리 (Q&A 스레드 등)
4. **긴 프롬프트**: GPT가 유리할 수 있음 (3000자 이상)

**현재 점수 시스템은 대체로 합리적이지만, 다음 조정을 고려할 수 있음:**
- 복잡한 분석 작업에 대한 GPT 가중치 증가
- 한국어 비중에 따른 가변 점수
- 프롬프트 길이에 따른 추가 가중치

