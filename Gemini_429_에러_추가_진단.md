# Gemini 2.5 Pro 429 에러 추가 진단

**상황**: 
- ✅ 유료 계정
- ✅ 할당량 여유 (2% 사용)
- ✅ API 키 제한 없음
- ✅ Vercel 환경 변수 업데이트 완료 (2h ago)

**그런데도 429 에러 발생** → 다른 원인 확인 필요

---

## 🔍 추가 확인 사항

### 1. Vercel 재배포 완료 여부 확인

**확인 방법**:
1. Vercel 대시보드 → **Deployments** 탭
2. 최신 배포 확인:
   - 상태가 **"Ready"**인지 확인
   - 배포 시간이 환경 변수 업데이트 시간(2h ago) 이후인지 확인
   - 환경 변수 업데이트 후 **새로운 배포가 있었는지** 확인

**문제 가능성**:
- 환경 변수를 업데이트했지만 재배포가 안 됨
- 환경 변수는 업데이트되었지만 배포가 실패함

**해결 방법**:
1. **수동 재배포**:
   - Deployments → 최신 배포 → "..." → **Redeploy**
2. **배포 완료 대기**:
   - 배포가 완료될 때까지 대기 (2-5분)
   - 배포 완료 후 **1-2분 추가 대기** (환경 변수 적용 시간)

---

### 2. API 키가 올바른 프로젝트를 가리키는지 확인

**확인 방법**:
1. **로컬 `.env.local`의 API 키 확인**:
   ```bash
   # 로컬에서 확인
   cat .env.local | grep GEMINI_API_KEY
   ```

2. **Vercel 환경 변수의 API 키 확인**:
   - Vercel 대시보드 → Settings → Environment Variables
   - `GEMINI_API_KEY` 값 확인
   - **처음 10자와 마지막 4자 비교** (보안상 전체는 안 보임)

3. **Google Cloud Console에서 API 키 확인**:
   - Google Cloud Console → API 및 서비스 → 사용자 인증 정보
   - API 키 목록에서 각 키의 **처음 10자와 마지막 4자** 확인
   - Vercel에 설정된 키와 일치하는지 확인

**문제 가능성**:
- Vercel에 설정된 API 키가 다른 프로젝트의 키일 수 있음
- 여러 프로젝트가 있어서 혼동 가능

**해결 방법**:
- 통합한 프로젝트의 API 키만 사용
- 다른 프로젝트의 API 키는 삭제하거나 비활성화

---

### 3. 실제 사용 중인 프로젝트 확인

**확인 방법**:
1. **Google Cloud Console → API 및 서비스 → 할당량**
2. **프로젝트 선택** (상단에서)
3. 통합한 프로젝트 선택
4. **Generative Language API** → **gemini-2.5-pro** 할당량 확인
5. **사용량 로그 확인**:
   - 로깅 → 로그 탐색기
   - 필터: `resource.labels.service="generativelanguage.googleapis.com"`
   - 429 에러 발생 시간 확인
   - 어떤 프로젝트에서 발생했는지 확인

**문제 가능성**:
- 다른 프로젝트에서 API 호출이 발생하고 있을 수 있음
- 여러 프로젝트가 활성화되어 있어서 혼동 가능

---

### 4. Vercel Functions 로그에서 실제 사용 중인 API 키 확인

**확인 방법**:
1. Vercel 대시보드 → **Deployments** → 최신 배포
2. **Functions** 탭 클릭
3. `/api/analyze-design-sheet` 로그 확인
4. 다음 로그 찾기:
   ```
   Gemini API 키 확인: AIzaSy... (길이: 39)
   ```
5. **API 키의 처음 10자와 마지막 4자 확인**
6. 로컬 `.env.local`과 비교

**문제 가능성**:
- Vercel Functions가 여전히 이전 API 키를 사용 중일 수 있음
- 환경 변수가 제대로 적용되지 않았을 수 있음

---

### 5. API 키 활성화 상태 확인

**확인 방법**:
1. Google Cloud Console → **API 및 서비스 → 사용자 인증 정보**
2. API 키 목록에서 사용 중인 키 클릭
3. **상태** 확인:
   - ✅ **활성화됨** (Enabled)
   - ❌ **비활성화됨** (Disabled) → 문제!

**문제 가능성**:
- API 키가 실수로 비활성화되었을 수 있음
- 또는 다른 프로젝트의 키를 사용 중일 수 있음

---

## 🚨 즉시 확인해야 할 사항 (우선순위)

### 1. Vercel 재배포 완료 여부 (최우선)

**확인**:
- Deployments 탭에서 최신 배포 시간 확인
- 환경 변수 업데이트 시간(2h ago) 이후에 배포가 있었는지 확인

**해결**:
- 배포가 없었다면 **수동 재배포** 실행
- 배포 완료 후 2-3분 대기

---

### 2. Vercel Functions 로그에서 실제 API 키 확인

**확인**:
- Functions 로그에서 "Gemini API 키 확인" 메시지 찾기
- API 키의 처음 10자와 마지막 4자 확인
- 로컬 `.env.local`과 비교

**해결**:
- 다르다면 환경 변수 다시 업데이트 및 재배포

---

### 3. Google Cloud Console에서 실제 사용 중인 프로젝트 확인

**확인**:
- 할당량 페이지에서 프로젝트 선택
- 통합한 프로젝트가 맞는지 확인
- 사용량 로그에서 429 에러가 어떤 프로젝트에서 발생했는지 확인

---

## 💡 임시 해결 방법

현재 Fallback 로직이 작동하고 있으므로:
- `gemini-2.5-pro` 실패 → `gemini-2.0-flash`로 자동 전환
- 기능은 정상 작동 (Pro 모델만 사용 못함)

**임시 조치**:
1. Flash 모델로 우선 사용 (이미 적용됨)
2. 위의 확인 사항들 점검
3. 문제 해결 후 Pro 모델 사용 재개

---

## 📊 예상 원인 우선순위 (업데이트)

1. **Vercel 재배포 미완료** (60% 가능성)
   - 환경 변수는 업데이트했지만 재배포가 안 됨
   
2. **API 키가 다른 프로젝트를 가리킴** (30% 가능성)
   - 여러 프로젝트가 있어서 혼동
   
3. **환경 변수 적용 지연** (10% 가능성)
   - 배포 완료 후 환경 변수 적용 시간 필요

---

## ✅ 체크리스트

- [ ] Vercel 재배포 완료 여부 확인
- [ ] Vercel Functions 로그에서 실제 API 키 확인
- [ ] Google Cloud Console에서 실제 사용 중인 프로젝트 확인
- [ ] API 키 활성화 상태 확인
- [ ] 사용량 로그에서 429 에러 발생 프로젝트 확인

---

**작성자**: AI Assistant  
**다음 단계**: Vercel 재배포 확인 및 Functions 로그 확인 (최우선)

