# 프로덕션 서버 설계서 분석 오류 해결 가이드

**작성일**: 2024-12-16  
**문제**: 프로덕션 서버에서 설계서 이미지 분석 시 429 에러 발생  
**에러 메시지**: `Resource has been exhausted (e.g. check quota)`

---

## 🔍 문제 원인

1. **Fallback 로직 부재**: 설계서 분석 API가 `gemini-2.5-pro` 할당량 초과 시 대체 모델로 전환하지 않음
2. **프로덕션 환경 변수 미반영**: Vercel 등 프로덕션 서버의 환경 변수가 업데이트되지 않았을 수 있음
3. **할당량 초과**: Gemini 2.5 Pro 모델의 할당량이 실제로 초과되었을 수 있음

---

## ✅ 해결 방법

### 1. 코드 수정 완료 ✅

설계서 분석 API와 의료 이미지 분석 API에 **Fallback 로직**을 추가했습니다:

- **`gemini-2.5-pro` 실패 시 → `gemini-2.0-flash`로 자동 전환**
- **429 에러 감지 및 재시도 로직 추가**
- **Q&A API와 동일한 안정성 확보**

**수정된 파일**:
- `app/api/analyze-design-sheet/route.ts`
- `app/api/analyze-medical-image/route.ts`

---

### 2. 프로덕션 서버 환경 변수 확인 및 업데이트

#### Vercel 환경 변수 확인

1. **Vercel 대시보드 접속**
   - https://vercel.com/dashboard
   - 프로젝트 선택

2. **Settings → Environment Variables** 이동

3. **환경 변수 확인**:
   ```
   GEMINI_API_KEY=AIzaSy... (새로 통합한 API 키)
   GOOGLE_API_KEY=AIzaSy... (동일한 키 사용 가능)
   GOOGLE_CUSTOM_SEARCH_API_KEY=AIzaSy... (동일한 키 사용 가능)
   GOOGLE_CUSTOM_SEARCH_ENGINE_ID=e291b61462...
   ```

4. **환경 변수가 올바른지 확인**:
   - ✅ `GEMINI_API_KEY`가 새로 통합한 프로젝트의 API 키인지 확인
   - ✅ 모든 환경 변수가 최신 값인지 확인

5. **환경 변수 업데이트가 필요한 경우**:
   - 기존 환경 변수 삭제
   - 새 환경 변수 추가
   - **중요**: 모든 환경(Production, Preview, Development)에 적용

6. **재배포**:
   - Vercel에서 자동으로 재배포되거나
   - 수동으로 "Redeploy" 클릭

---

### 3. 환경 변수 확인 방법

#### 로컬에서 확인 (개발 환경)

```bash
# .env.local 파일 확인
cat .env.local | grep GEMINI_API_KEY
cat .env.local | grep GOOGLE_API_KEY
```

#### 프로덕션에서 확인 (Vercel Functions 로그)

Vercel 대시보드 → 프로젝트 → **Functions** 탭에서 로그 확인:

```
Gemini API 키 확인: AIzaSyCqes...92Kk (길이: 39)
환경: production
```

**예상 로그**:
- ✅ 정상: `Gemini API 키 확인: AIzaSy... (길이: 39)`
- ❌ 문제: `GEMINI_API_KEY가 설정되지 않았습니다!`

---

### 4. 할당량 확인

#### Google Cloud Console에서 확인

1. **Google Cloud Console 접속**
   - https://console.cloud.google.com/
   - 통합한 프로젝트 선택

2. **API 및 서비스 → 할당량** 이동

3. **Gemini API 할당량 확인**:
   - `Generative Language API` 할당량 확인
   - `gemini-2.5-pro` 모델 할당량 확인
   - `gemini-2.0-flash` 모델 할당량 확인

4. **할당량 초과 시**:
   - 할당량 증가 요청
   - 또는 Flash 모델로 우선 사용 (이미 Fallback 로직 추가됨)

---

## 🔧 Fallback 로직 동작 방식

### 설계서 분석 API

```typescript
// 1차 시도: gemini-2.5-pro
// 할당량 초과 시 → 2차 시도: gemini-2.0-flash
// 2차 시도도 실패 시 → 에러 반환
```

### 에러 감지

다음 에러가 감지되면 자동으로 Fallback 실행:
- `429 Too Many Requests`
- `Resource has been exhausted`
- `quota exceeded`
- `rate limit`

### 재시도 로직

- **1차 실패**: 2초 대기 후 Flash 모델로 전환
- **2차 실패**: 에러 반환 (사용자에게 알림)

---

## 📊 테스트 방법

### 로컬에서 테스트

1. **설계서 이미지 업로드**
2. **브라우저 콘솔에서 로그 확인**:
   ```
   [설계서 분석] 모델 시도: gemini-2.5-pro (시도 1/2)
   [설계서 분석] ⚠️ gemini-2.5-pro 할당량 초과 → gemini-2.0-flash 모델로 폴백 시도...
   [설계서 분석] 모델 시도: gemini-2.0-flash (시도 2/2)
   ```

### 프로덕션에서 테스트

1. **Vercel Functions 로그 확인**
2. **설계서 분석 시도**
3. **로그에서 Fallback 동작 확인**

---

## 🚨 추가 확인 사항

### 1. API 키 권한 확인

새로 통합한 API 키가 다음 권한을 가지고 있는지 확인:
- ✅ Generative Language API 활성화
- ✅ Google Custom Search API 활성화 (검색 기능용)
- ✅ Google Sheets API 활성화 (있는 경우)

### 2. 결제 계정 확인

- Google Cloud Console → **결제** 탭
- 결제 계정이 올바르게 연결되어 있는지 확인
- 무료 할당량 초과 시 결제 계정 필요

### 3. 프로젝트 확인

- 통합한 프로젝트가 올바른 프로젝트인지 확인
- 여러 프로젝트가 있으면 혼동 가능

---

## ✅ 해결 완료 체크리스트

- [x] 코드 수정 완료 (Fallback 로직 추가)
- [ ] Vercel 환경 변수 확인 및 업데이트
- [ ] 프로덕션 서버 재배포
- [ ] 프로덕션에서 테스트
- [ ] 할당량 확인 (필요 시)

---

## 📝 참고

### Q&A API와 동일한 안정성

Q&A API에는 이미 Fallback 로직이 있었지만, 설계서 분석 API에는 없었습니다. 이제 **모든 이미지 분석 API에 동일한 Fallback 로직**이 적용되어 안정성이 향상되었습니다.

### 모델 선택 전략

- **`gemini-2.5-pro`**: 고품질 이미지 분석 (우선 사용)
- **`gemini-2.0-flash`**: 할당량 초과 시 대체 모델 (Fallback)

---

**작성자**: AI Assistant  
**상태**: 코드 수정 완료 ✅  
**다음 단계**: 프로덕션 환경 변수 확인 및 재배포

