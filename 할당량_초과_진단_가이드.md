# Gemini 할당량 초과 문제 진단 가이드

## 🔍 문제 상황
- 원래 잘 작동했는데 갑자기 `gemini-2.5-pro` 할당량 초과 에러 발생
- 유료 버전 사용 중
- `.env.local`에서 `GEMINI_API_KEY`와 `GOOGLE_API_KEY`를 동일하게 설정

## ⚠️ 중요: API 키 설정

**`GEMINI_API_KEY`와 `GOOGLE_API_KEY`는 같은 키를 사용해도 됩니다!**

### 1. GEMINI_API_KEY
- **용도**: Google Gemini API (AI 모델 호출)
- **발급 위치**: Google Cloud Console > API 및 서비스 > 사용자 인증 정보
- **사용 위치**: 
  - `app/api/generate-qa/route.ts`
  - `app/api/analyze-design-sheet/route.ts`
  - `app/api/analyze-medical-image/route.ts`

### 2. GOOGLE_API_KEY (또는 GOOGLE_CUSTOM_SEARCH_API_KEY)
- **용도**: Google Custom Search API (웹 검색), Google Sheets API
- **발급 위치**: Google Cloud Console > API 및 서비스 > 사용자 인증 정보
- **사용 위치**: `lib/google-search.ts`, `lib/google-sheets.ts`
- **필수**: Custom Search Engine ID도 함께 필요

### ✅ 권장 설정 (같은 키 사용)
```env
# Google Cloud Console에서 발급한 하나의 API 키를 공유 사용
GEMINI_API_KEY=AIzaSy... (Google Cloud API 키)
GOOGLE_API_KEY=AIzaSy... (동일한 키 - 같은 값!)
GOOGLE_CUSTOM_SEARCH_ENGINE_ID=your-search-engine-id
```

**💡 왜 같은 키를 사용해도 되나요?**
1. ✅ **간단함**: 키 하나만 관리하면 됨
2. ✅ **비용 동일**: 같은 프로젝트의 키이므로 비용 차이 없음
3. ✅ **관리 편의**: 키 하나만 업데이트하면 됨
4. ✅ **코드 호환**: 현재 코드 로직과 완벽히 호환됨
5. ✅ **같은 Google Cloud API 키**: Gemini, Custom Search, Sheets 모두 같은 Google Cloud API 키 사용

### ⚠️ 주의사항
- **같은 키를 사용해도 문제없습니다!** (할당량 초과와 무관)
- 할당량 초과는 **프로젝트의 할당량 제한** 때문이지, 키가 같아서가 아닙니다
- Custom Search Engine ID는 별도로 발급받아야 합니다

## 🔧 해결 방법

### 1단계: API 키 확인

**💡 중요**: 현재 설정이 올바릅니다!
- ✅ `GEMINI_API_KEY`와 `GOOGLE_API_KEY`가 같은 키를 사용하는 것은 **정상**입니다
- ✅ `GOOGLE_CUSTOM_SEARCH_ENGINE_ID`는 별도 ID이므로 정상입니다
- ⚠️ **할당량 초과 문제는 키 설정과 무관**합니다

#### 1-1. 현재 설정 확인
현재 `.env.local` 설정이 올바릅니다:
```env
GEMINI_API_KEY=AIzaSy... (Google Cloud API 키)
GOOGLE_API_KEY=AIzaSy... (동일한 키 - 정상!)
GOOGLE_CUSTOM_SEARCH_ENGINE_ID=... (별도 ID - 정상!)
```

**✅ 추가 작업 불필요**: 키 설정은 이미 올바릅니다!

#### 1-2. 할당량 초과 원인 확인 (키 설정과 무관)

**Step 1: Google Cloud Console 접속**
1. https://console.cloud.google.com/ 접속
2. **프로젝트 선택**: "amazing-biz-blog" 프로젝트 선택 (Gemini API 키와 동일한 프로젝트)

**Step 2: Custom Search API 활성화**
1. 왼쪽 메뉴에서 **"API 및 서비스"** > **"라이브러리"** 클릭
2. 검색창에 **"Custom Search API"** 입력
3. **"Custom Search API"** 클릭
4. **"사용 설정"** 버튼 클릭

**Step 3: API 키 생성**
1. 왼쪽 메뉴에서 **"API 및 서비스"** > **"사용자 인증 정보"** 클릭
2. 상단의 **"+ 사용자 인증 정보 만들기"** 클릭
3. **"API 키"** 선택
4. 생성된 API 키 복사
5. (선택사항) API 키 제한 설정:
   - 생성된 키 옆 **연필 아이콘** 클릭
   - **"API 제한사항"** 선택
   - **"키 제한"** > **"Custom Search API"** 선택
   - **"저장"** 클릭

**Step 4: Custom Search Engine 생성 (Search Engine ID 필요)**
1. https://programmablesearchengine.google.com/controlpanel/create 접속
2. **"검색 엔진 만들기"** 클릭
3. **검색 엔진 이름**: 원하는 이름 입력 (예: "amazing-biz-blog-search")
4. **검색할 사이트**: 
   - 전체 웹 검색: `*` 입력
   - 특정 사이트만: `example.com` 입력
5. **"만들기"** 클릭
6. 생성된 검색 엔진 클릭
7. **"검색 엔진 ID"** 복사 (예: `012345678901234567890:abcdefghijk`)

**Step 5: .env.local 설정**
```env
# Gemini API 키 (이미 설정 완료)
GEMINI_API_KEY=AIzaSy... (Gemini API 키)

# Google Custom Search API 키 (방금 생성한 키)
GOOGLE_API_KEY=AIzaSy... (또는 GOOGLE_CUSTOM_SEARCH_API_KEY로 설정)
GOOGLE_CUSTOM_SEARCH_API_KEY=AIzaSy... (위와 동일한 키)
GOOGLE_CUSTOM_SEARCH_ENGINE_ID=012345678901234567890:abcdefghijk (Step 4에서 복사한 ID)
```

**⚠️ 중요**: 
- `GOOGLE_API_KEY`와 `GOOGLE_CUSTOM_SEARCH_API_KEY`는 같은 키를 사용해도 됩니다
- 하지만 `GEMINI_API_KEY`와는 **반드시 다른 키**여야 합니다!
- `GOOGLE_CUSTOM_SEARCH_ENGINE_ID`는 Custom Search Engine 생성 시 받은 ID입니다

### 2단계: 서버 재시작
```bash
# 개발 서버 재시작
npm run dev
```

### 3단계: 로그 확인
콘솔에서 다음 로그를 확인하세요:
- `[Q&A 생성] [Step 1] 질문 생성 프롬프트 길이: ... 문자 (약 ... 토큰)`
- `[Q&A 생성] [Step 2] 답변 생성 프롬프트 길이: ... 문자 (약 ... 토큰)`
- `[Q&A 생성] [Step 3-...] 프롬프트 길이: ... 문자 (약 ... 토큰)`
- `[Q&A 생성] [gemini-2.5-pro] 프롬프트 길이: ... 문자 (약 ... 토큰)`

### 4단계: 할당량 확인
1. Google Cloud Console 접속: https://console.cloud.google.com/
2. **API 및 서비스** > **할당량** 메뉴
3. **"Generative Language API"** 검색
4. `gemini-2.5-pro` 모델의 할당량 확인:
   - **RPM (Requests Per Minute)**: 150
   - **TPM (Tokens Per Minute)**: 확인 필요
   - **일일 할당량**: 확인 필요

## 📊 프롬프트 길이 최적화

프롬프트가 너무 길면 토큰 사용량이 증가하여 할당량 초과가 발생할 수 있습니다.

### 현재 최적화 상태
- ✅ 대화 히스토리: 최근 4개 메시지만 사용 (6개 → 4개로 감소)
- ✅ 각 메시지: 80자로 제한
- ✅ API 호출 사이: 1초 지연 추가

### 추가 최적화 가능
프롬프트 로그를 확인하여 특정 단계의 프롬프트가 너무 길면:
1. 불필요한 예시 제거
2. 히스토리 메시지 수 더 줄이기 (4개 → 2개)
3. 프롬프트 템플릿 단순화

## 🚨 할당량 초과 시 대응

### 즉시 대응
1. **1초 지연 확인**: 각 API 호출 사이에 1초 지연이 있는지 확인
2. **동시 요청 확인**: 여러 사용자가 동시에 요청하지 않는지 확인
3. **프롬프트 길이 확인**: 로그에서 프롬프트 길이가 비정상적으로 긴지 확인

### 장기 대응
1. **할당량 증가 요청**: Google Cloud Console에서 할당량 증가 요청
2. **모델 변경**: `gemini-2.0-flash`를 더 많이 사용 (할당량이 더 높음)
3. **캐싱 추가**: 동일한 요청에 대한 결과 캐싱

## 📝 체크리스트

### API 키 설정 (이미 올바르게 설정됨)
- [x] `GEMINI_API_KEY`가 올바른 Google Cloud API 키인지 확인 (✅ 완료)
- [x] `GOOGLE_API_KEY`가 `GEMINI_API_KEY`와 동일한 키인지 확인 (✅ 정상 - 같은 키 사용 가능)
- [x] `GOOGLE_CUSTOM_SEARCH_ENGINE_ID` 설정 완료 (✅ 완료)
- [x] `.env.local`에 모든 키가 올바르게 설정되었는지 확인 (✅ 완료)

### 서버 설정
- [ ] 서버 재시작 완료 (`npm run dev`)
- [ ] 콘솔 로그에서 프롬프트 길이 확인
- [ ] Google Cloud Console에서 할당량 확인
- [ ] 1초 지연이 제대로 작동하는지 확인

### Custom Search API 설정
- [ ] Custom Search API 활성화 완료
- [ ] Custom Search Engine 생성 완료
- [ ] Search Engine ID 복사 및 `.env.local`에 설정 완료

## 💡 참고

### API 키 요약
- **GEMINI_API_KEY**: Google Cloud API 키 (Gemini API 호출용)
- **GOOGLE_API_KEY**: **같은 Google Cloud API 키 사용 가능** (Custom Search, Sheets API 호출용)
- **✅ 같은 키를 사용해도 전혀 문제없습니다!**
- **할당량 초과는 키 설정과 무관**하며, 프로젝트의 할당량 제한 때문입니다

### 빠른 링크
- **Gemini API 키**: https://aistudio.google.com/apikey
- **Google Cloud Console**: https://console.cloud.google.com/
- **Custom Search API 활성화**: https://console.cloud.google.com/apis/library/customsearch.googleapis.com
- **API 키 관리**: https://console.cloud.google.com/apis/credentials
- **Custom Search Engine 생성**: https://programmablesearchengine.google.com/controlpanel/create

### 비용 정보
- **Gemini API**: 사용량 기반 과금 (프로젝트에 결제 수단 연결 필요)
- **Custom Search API**: 
  - 무료 할당량: 일일 100회 검색
  - 초과 시: 검색당 $5 (10,000회당 $50)
  - 상세: https://developers.google.com/custom-search/v1/overview#pricing

