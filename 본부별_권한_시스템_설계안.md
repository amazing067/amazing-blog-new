# 본부별 권한 시스템 설계안

## 📋 요구사항 정리

1. **본부별 사용자 구분**: 사용자들을 본부별로 그룹화
2. **본부장 권한**: 같은 본부 팀원들의 데이터 조회 가능
3. **통계 권한 분리**:
   - **관리자**: 모든 통계 (글 수, Q&A 수, 토큰 사용량)
   - **본부장**: 같은 본부 팀원들의 글 수, Q&A 수만 조회 (토큰 사용량 제외)

---

## 🗄️ 데이터베이스 스키마 설계

### 1. profiles 테이블에 필드 추가

```sql
-- profiles 테이블에 본부 관련 필드 추가
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS department_id TEXT,  -- 본부 ID (예: 'seoul', 'busan', 'daegu')
ADD COLUMN IF NOT EXISTS department_name TEXT; -- 본부명 (예: '서울본부', '부산본부', '대구본부')

-- 인덱스 생성
CREATE INDEX IF NOT EXISTS profiles_department_id_idx ON profiles(department_id);
```

### 2. departments 테이블 생성 (선택사항 - 본부 정보 관리용)

```sql
-- 본부 정보 테이블 (선택사항)
CREATE TABLE IF NOT EXISTS departments (
  id TEXT PRIMARY KEY,  -- 'seoul', 'busan', 'daegu' 등
  name TEXT NOT NULL,  -- '서울본부', '부산본부', '대구본부'
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 기본 본부 데이터 삽입
INSERT INTO departments (id, name) VALUES
  ('seoul', '서울본부'),
  ('busan', '부산본부'),
  ('daegu', '대구본부'),
  ('incheon', '인천본부'),
  ('gwangju', '광주본부')
ON CONFLICT (id) DO NOTHING;
```

### 3. role 확장

현재 `role` 필드: `'user' | 'admin'`
→ 확장: `'user' | 'admin' | 'department_head'` (본부장)

---

## 🔐 권한 시스템 설계

### 역할별 권한 매트릭스

| 기능 | 일반 사용자 | 본부장 | 관리자 |
|------|------------|--------|--------|
| 자신의 글 작성/수정 | ✅ | ✅ | ✅ |
| 자신의 Q&A 작성 | ✅ | ✅ | ✅ |
| 같은 본부 팀원 글 수 조회 | ❌ | ✅ | ✅ |
| 같은 본부 팀원 Q&A 수 조회 | ❌ | ✅ | ✅ |
| 같은 본부 팀원 토큰 사용량 | ❌ | ❌ | ✅ |
| 모든 사용자 통계 | ❌ | ❌ | ✅ |
| 회원 관리 | ❌ | ❌ | ✅ |

---

## 🎨 UI/UX 설계

### 1. 회원가입/회원 관리 화면

#### 회원가입 시
- 본부 선택 드롭다운 추가
- 예: "서울본부", "부산본부", "대구본부" 등

#### 관리자 회원 관리 화면 (`/admin/users`)
- 본부별 필터 추가
- 본부장 지정 기능 추가
- 본부별 그룹화 표시

### 2. 통계 화면 (`/admin/stats`)

#### 관리자용 통계
```
┌─────────────────────────────────────┐
│ 전체 통계 (관리자 전용)              │
├─────────────────────────────────────┤
│ [본부별 필터] [전체] ▼              │
│                                     │
│ 사용자명 | 본부 | 글 수 | Q&A | 토큰│
│ 홍길동   | 서울 |  15  |  8  | 1.2M│
│ 김철수   | 부산 |  12  |  5  | 0.8M│
└─────────────────────────────────────┘
```

#### 본부장용 통계 (`/department/stats`)
```
┌─────────────────────────────────────┐
│ 서울본부 통계 (본부장 전용)           │
├─────────────────────────────────────┤
│                                     │
│ 사용자명 | 글 수 | Q&A 수            │
│ 홍길동   |  15  |  8                │
│ 이영희   |  10  |  6                │
│ 박민수   |   8  |  4                │
│                                     │
│ 총계: 33건 | 18건                   │
└─────────────────────────────────────┘
```

---

## 💻 구현 계획

### Phase 1: 데이터베이스 스키마 업데이트

1. **SQL 마이그레이션 파일 생성**
   - `supabase-schema-departments.sql` 생성
   - profiles 테이블에 `department_id`, `department_name` 추가
   - role 확장: `'department_head'` 추가

2. **기존 사용자 마이그레이션**
   - 기존 사용자들의 본부 정보 설정 방법 결정
   - 관리자가 수동으로 설정하거나 기본값 부여

### Phase 2: 권한 체크 로직 구현

1. **권한 체크 유틸리티 함수 생성**
   ```typescript
   // lib/auth/permissions.ts
   export function canViewDepartmentStats(userRole: string, userDepartment: string, targetDepartment: string): boolean {
     if (userRole === 'admin') return true
     if (userRole === 'department_head' && userDepartment === targetDepartment) return true
     return false
   }
   
   export function canViewTokenUsage(userRole: string): boolean {
     return userRole === 'admin'
   }
   ```

2. **RLS 정책 업데이트**
   - 본부장이 같은 본부 팀원의 데이터를 조회할 수 있도록 정책 추가

### Phase 3: UI 구현

1. **회원가입 화면 수정**
   - 본부 선택 드롭다운 추가
   - `app/signup/page.tsx` 수정

2. **관리자 회원 관리 화면 수정**
   - 본부 필터 추가
   - 본부장 지정 기능 추가
   - `app/admin/users/page.tsx` 수정

3. **통계 화면 분리**
   - 관리자용: `app/admin/stats/page.tsx` (기존 유지, 토큰 표시)
   - 본부장용: `app/department/stats/page.tsx` (신규 생성, 토큰 제외)

### Phase 4: API 수정

1. **통계 API 수정**
   - `app/api/admin/stats/route.ts` 수정
   - 권한에 따라 다른 데이터 반환
   - 본부장은 토큰 정보 제외

---

## 🔧 구체적 구현 아이디어

### 아이디어 1: 간단한 구현 (추천)

**장점**: 빠른 구현, 유지보수 용이
**단점**: 본부 정보가 하드코딩됨

```typescript
// lib/constants/departments.ts
export const DEPARTMENTS = [
  { id: 'seoul', name: '서울본부' },
  { id: 'busan', name: '부산본부' },
  { id: 'daegu', name: '대구본부' },
  { id: 'incheon', name: '인천본부' },
  { id: 'gwangju', name: '광주본부' },
] as const

export type DepartmentId = typeof DEPARTMENTS[number]['id']
```

### 아이디어 2: 유연한 구현

**장점**: 본부 추가/삭제가 쉬움, 확장성 좋음
**단점**: departments 테이블 관리 필요

- departments 테이블 생성
- 관리자가 본부 추가/삭제 가능
- 동적으로 본부 목록 로드

### 아이디어 3: 하이브리드 (최종 추천)

**초기**: 아이디어 1 (간단한 구현)
**향후**: 필요시 아이디어 2로 마이그레이션

---

## 📊 통계 쿼리 예시

### 본부장용 통계 쿼리

```sql
-- 같은 본부 팀원들의 글 수, Q&A 수 조회
SELECT 
  p.id,
  p.username,
  p.full_name,
  p.department_name,
  COUNT(DISTINCT bp.id) as blog_count,
  COUNT(DISTINCT qa.id) as qa_count
FROM profiles p
LEFT JOIN blog_posts bp ON bp.user_id = p.id
LEFT JOIN qa_sets qa ON qa.user_id = p.id
WHERE p.department_id = $1  -- 본부장의 본부 ID
  AND p.role != 'admin'
GROUP BY p.id, p.username, p.full_name, p.department_name
ORDER BY blog_count DESC, qa_count DESC;
```

### 관리자용 통계 쿼리 (토큰 포함)

```sql
-- 모든 사용자의 통계 (토큰 포함)
SELECT 
  p.id,
  p.username,
  p.full_name,
  p.department_name,
  COUNT(DISTINCT bp.id) as blog_count,
  COUNT(DISTINCT qa.id) as qa_count,
  COALESCE(SUM(ul.total_tokens), 0) as total_tokens
FROM profiles p
LEFT JOIN blog_posts bp ON bp.user_id = p.id
LEFT JOIN qa_sets qa ON qa.user_id = p.id
LEFT JOIN usage_logs ul ON ul.user_id = p.id
GROUP BY p.id, p.username, p.full_name, p.department_name
ORDER BY p.department_name, blog_count DESC;
```

---

## 🚀 구현 우선순위

1. **1단계**: 데이터베이스 스키마 업데이트 (department_id, department_name 추가)
2. **2단계**: 회원가입/회원 관리 화면에 본부 선택 추가
3. **3단계**: 본부장 역할 추가 및 권한 체크 로직
4. **4단계**: 통계 화면 분리 (관리자/본부장)
5. **5단계**: RLS 정책 업데이트

---

## ❓ 추가 고려사항

### Q1: 본부장은 여러 명이 될 수 있나요?
- **A**: 네, 같은 본부에 여러 명의 본부장이 가능하도록 설계

### Q2: 본부장도 일반 사용자처럼 글을 작성할 수 있나요?
- **A**: 네, 본부장도 일반 사용자 권한을 모두 가지고, 추가로 통계 조회 권한만 가짐

### Q3: 본부 정보는 어떻게 관리하나요?
- **A**: 초기에는 하드코딩된 목록 사용, 향후 관리자 화면에서 추가/삭제 가능하도록 확장

### Q4: 기존 사용자들의 본부는 어떻게 설정하나요?
- **A**: 관리자가 `/admin/users`에서 일괄 설정하거나, 사용자가 프로필에서 설정

---

## 📝 다음 단계

이 설계안을 바탕으로 구현을 시작하시겠습니까?
1. 데이터베이스 스키마 업데이트 SQL 생성
2. 회원가입 화면에 본부 선택 추가
3. 통계 화면 분리 및 권한 체크 구현

어떤 것부터 시작할까요?

