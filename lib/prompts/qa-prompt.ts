/**
 * 보험카페 Q&A 자동 생성 프롬프트 템플릿
 * Version: 2.1
 * Last Updated: 2025-12-06
 */

export interface QAPromptData {
  productName: string
  targetPersona: string
  worryPoint: string
  sellingPoint: string
  feelingTone: string
  answerTone: string
  customerStyle?: string // 고객 스타일: 'friendly' | 'cold' | 'brief' | 'curious'
  designSheetImage?: string // Base64 이미지 (선택)
  designSheetAnalysis?: {
    premium?: string
    coverages?: string[]
    specialClauses?: string[]
  }
}

export interface ConversationMessage {
  role: 'customer' | 'agent'
  content: string
  step: number
}

export interface ConversationContext {
  initialQuestion: {
    title: string
    content: string
  }
  firstAnswer: string
  conversationHistory: ConversationMessage[]
  totalSteps: number
  currentStep: number
}

/**
 * Step 1: 일반인 질문 생성 프롬프트
 */
export function generateQuestionPrompt(data: QAPromptData): string {
  const { productName, targetPersona, worryPoint, feelingTone, customerStyle, designSheetImage, designSheetAnalysis } = data
  
  // 고객 스타일 톤을 함수 최상단에서 미리 계산
  const customerStyleTone = (() => {
    const style = customerStyle || 'curious'
    if (style === 'cold') return '차갑고 거리감 있는'
    if (style === 'brief') return '간결하고 직설적인'
    if (style === 'curious') return '정말 궁금해서 물어보는'
    return '정중하지만 거리감 있는'
  })()

  // 나이대 추출 (targetPersona에서)
  // "50대", "40대", "30대" 형식 또는 "50세", "40세" 형식 모두 지원
  // 특수 케이스 처리: "주부", "신혼부부", "자녀 있는 가족" 등
  let age = 30 // 기본값
  const ageDecadeMatch = targetPersona.match(/(\d+)대/) // "50대", "40대" 등
  const ageYearMatch = targetPersona.match(/(\d+)세/) // "50세", "40세" 등
  
  if (ageDecadeMatch) {
    // 나이대가 매칭되면 중간값으로 설정 (예: 50대 → 55세, 40대 → 45세, 30대 → 35세)
    const decade = parseInt(ageDecadeMatch[1])
    age = decade + 5
  } else if (ageYearMatch) {
    // "세" 형식이면 그대로 사용
    age = parseInt(ageYearMatch[1])
  } else {
    // 특수 케이스 처리
    if (targetPersona.includes('신혼부부')) {
      age = 32 // 신혼부부는 보통 30대 초반
    } else if (targetPersona.includes('자녀 있는 가족')) {
      age = 38 // 자녀 있는 가족은 보통 30대 중후반
    } else if (targetPersona.includes('주부')) {
      // 주부의 경우 나이대가 명시되어 있을 수 있음 (예: "40대 주부")
      // 이미 위에서 처리되지만, 혹시 "주부"만 있으면 30대로 설정
      age = 30
    }
  }
  
  // 성별 추출
  let gender = '남' // 기본값
  if (targetPersona.includes('여') || targetPersona.includes('여성')) {
    gender = '여'
  } else if (targetPersona.includes('남') || targetPersona.includes('남성')) {
    gender = '남'
  } else if (targetPersona.includes('주부')) {
    // 주부는 일반적으로 여성
    gender = '여'
  } else if (targetPersona.includes('신혼부부')) {
    // 신혼부부는 남녀 모두 포함하지만 질문자는 주로 여성 또는 남성 중 하나로 가정
    // 질문 생성 시에는 "부부"라는 표현으로 자연스럽게 처리되도록 함
    gender = '남' // 기본값 (실제로는 부부 모두 포함)
  } else if (targetPersona.includes('자녀 있는 가족')) {
    // 가족은 남녀 모두 포함하지만 질문자는 주로 부모 중 하나로 가정
    gender = '남' // 기본값 (실제로는 부모 모두 포함)
  }

  // 나이대별 말투 가이드
  let ageToneGuide = ''
  if (age < 30) {
    ageToneGuide = `
   - 20대 말투: "이거 괜찮나요?", "혹시...", "설계서 받았는데 잘 모르겠어요 ㅠㅠ", "이거 맞나요??"
   - 물음표 중복 사용, "요" 체 적극 사용, 이모티콘 사용 가능`
  } else if (age < 50) {
    ageToneGuide = `
   - 30-40대 말투: "이거 괜찮은가요?", "혹시 다른 보험사도 괜찮은지...", "설계서 받았는데 잘 모르겠어서 질문드립니다"
   - 정중한 표현, "요" 체 사용, 비교 요청 자연스럽게`
  } else {
    ageToneGuide = `
   - 50대 이상 말투: "이게 괜찮은 건지 모르겠어서요", "설계서를 받았는데 잘 모르겠어서 문의드립니다"
   - 더 정중한 표현, "요" 체 적극 사용, 문의드립니다 형식 선호`
  }

  // 설계서 정보 추출
  const premiumInfo = designSheetAnalysis?.premium ? `보험료: ${designSheetAnalysis.premium}` : ''
  const coverageInfo = designSheetAnalysis?.coverages?.length ? `담보: ${designSheetAnalysis.coverages.slice(0, 3).join(', ')}` : ''
  const specialClauseInfo = designSheetAnalysis?.specialClauses?.length ? `특약: ${designSheetAnalysis.specialClauses.slice(0, 2).join(', ')}` : ''

  // 고객 스타일별 톤 가이드
  const customerStyleGuide = (() => {
    const style = customerStyle || 'curious' // 기본값: 궁금한 것만 물어보는 스타일
    
    if (style === 'cold') {
      return {
        tone: '차갑고 거리감 있는',
        description: '설계사에게 친근하게 대하지 않고, 거리감을 두며 차갑게 질문합니다',
        examples: [
          '설계서 받았는데 보험료가 월 3만원이에요 이게 적정한가요?',
          '다른 보험사는 얼마인가요?',
          '이 특약이 정말 필요한가요?',
          '보험료가 부담스러운데 줄일 방법이 있나요?'
        ],
        avoid: [
          '과도한 정중함 ("감사합니다", "부탁드립니다" 등)',
          '친근한 표현 ("설계사님", "도와주세요" 등)',
          '불필요한 설명이나 배경 설명'
        ],
        focus: '핵심 질문만 간결하게, 불필요한 말 없이'
      }
    } else if (style === 'brief') {
      return {
        tone: '간결하고 직설적인',
        description: '불필요한 말 없이 핵심만 물어봅니다',
        examples: [
          '보험료가 적정한가요?',
          '다른 상품과 비교하면 어떤가요?',
          '이 특약 필요하나요?',
          '보험료 줄일 수 있나요?'
        ],
        avoid: [
          '긴 설명이나 배경 설명',
          '과도한 정중함',
          '불필요한 감정 표현'
        ],
        focus: '최대한 짧고 간결하게, 핵심만'
      }
    } else if (style === 'curious') {
      return {
        tone: '정말 궁금해서 물어보는',
        description: '짜고 치는 느낌이 아니라 정말 모르는 게 있어서 궁금해서 물어봅니다',
        examples: [
          '설계서 받았는데 이 보험료가 적정한 건지 모르겠어서요',
          '다른 보험사는 어떤지 궁금해서요',
          '이 특약이 정말 필요한 건지 잘 모르겠어요',
          '보험료가 부담스러운데 줄일 방법이 있을까요?'
        ],
        avoid: [
          '과도한 친근함이나 정중함',
          '짜고 치는 느낌의 표현',
          '불필요한 감정 과장'
        ],
        focus: '진짜 모르는 게 있어서 궁금해서 물어보는 자연스러운 톤'
      }
    } else { // friendly (기본값 유지하되, 더 차갑게 조정)
      return {
        tone: '정중하지만 거리감 있는',
        description: '정중하지만 친근하지 않고 거리감을 둡니다',
        examples: [
          '설계서 받았는데 보험료가 월 3만원이에요 이게 적정한가요?',
          '다른 보험사도 괜찮은지 궁금해서요',
          '이 특약이 필요한 건지 모르겠어서 질문드립니다',
          '보험료가 부담스러운데 줄일 수 있는 방법이 있을까요?'
        ],
        avoid: [
          '과도한 친근함',
          '짜고 치는 느낌',
          '불필요한 감정 표현'
        ],
        focus: '정중하지만 거리감 있게, 핵심 질문 중심'
      }
    }
  })()

  const prompt = `당신은 보험 지식이 부족한 일반인이며, 현재 보험 가입을 두고 고민 중인 커뮤니티 유저입니다.

[역할 설정]
- **나이: ${age}세 (매우 중요! 반드시 이 나이로 질문을 작성하세요!)**
- **성별: ${gender === '남' ? '남성' : '여성'} (매우 중요! 반드시 이 성별로 질문을 작성하세요!)**
- 타겟 고객: ${targetPersona}
- 보험에 대한 지식이 거의 없는 일반인
- 설계서를 받았지만 내용을 제대로 이해하지 못함
- 다른 사람들의 조언을 구하고 싶어함

[핵심 지침]

1. **고객 스타일 (매우 중요!)**: ${customerStyleGuide.tone} 톤으로 작성하세요
   - 스타일 설명: ${customerStyleGuide.description}
   - 예시:
${customerStyleGuide.examples.map(ex => `     * "${ex}"`).join('\n')}
   - 피해야 할 것:
${customerStyleGuide.avoid.map(av => `     * ${av}`).join('\n')}
   - 핵심: ${customerStyleGuide.focus}
   
   - **⚠️ 짜고 치는 느낌 절대 금지**: 
     * 설계사에게 과도하게 친근하거나 정중하지 마세요
     * 정말 모르는 게 있어서 궁금해서 물어보는 자연스러운 톤을 유지하세요
     * 불필요한 감사 인사나 배경 설명은 최소화하세요
     * 핵심 질문만 간결하게 물어보세요

2. **말투**: 절대 전문가처럼 보이지 말 것. 오타, 은어, 구어체 사용 필수.
${ageToneGuide}
   - 자연스러운 오타 패턴 (적절한 수준으로 허용):
     * "이거 괜찮나요?" → "이거 괜찮나요??" (물음표 중복)
     * "혹시..." → "혹시...?" (끝에 물음표)
     * "설계서 받았는데" → "설계서 받았는데요" (요 체)
     * "궁금해서" → "궁금해서요" (요 체)
     * "보험료가" → "보험료가요" (요 체)
     * **자연스러운 맞춤법 오타 허용**:
       - "했어요" → "햇어요" (가끔 허용)
       - "받았어요" → "받았어요" 또는 "받앗어요" (가끔 허용)
       - "궁금해요" → "궁금해요" 또는 "궁금햐요" (가끔 허용)
       - "알겠어요" → "알겠어요" 또는 "알겟어요" (가끔 허용)
     * **주의**: 전체적으로 계속 오타를 사용하지 말고, 가끔 자연스러운 오타만 허용하세요
     * 너무 많은 오타는 가독성을 해치므로 적절한 수준으로만 사용하세요
   
   - **⚠️ 마침표(.) 사용 절대 금지**: 
     * 문장 끝에 마침표를 사용하지 마세요
     * 물음표(?)나 느낌표(!)는 사용 가능하지만, 마침표는 절대 사용하지 마세요
     * 예: "설계서 받았는데요" (O), "설계서 받았는데요." (X)
     * 예: "이게 적정한가요?" (O), "이게 적정한가요." (X)

3. **금지어**: 전문 용어 사용 절대 금지
   - ❌ "납입면제" → ✅ "돈 안 내도 되는 거"
   - ❌ "해지환급금" → ✅ "중도 해지하면 돌려받는 돈"
   - ❌ "특약" → ✅ "추가 보장"
   - ❌ "담보" → ✅ "보장하는 거"
   - ❌ "보험료" → ✅ "보험료" (이건 괜찮음)

4. **설계서 언급 (매우 중요)**: 설계서를 구체적으로 언급하세요
${designSheetImage || designSheetAnalysis ? `
   - 설계서에서 확인한 정보를 자연스럽게 언급:
     ${premiumInfo ? `* "설계서 받았는데 보험료가 ${premiumInfo.includes('원') ? premiumInfo : premiumInfo + '원'}이에요. 이게 적정한가요?"` : ''}
     ${coverageInfo ? `* "설계서 보니까 ${coverageInfo}이 포함되어 있는데 이게 필요한 건가요?"` : ''}
     ${specialClauseInfo ? `* "설계서에 ${specialClauseInfo}이 있는데 이게 뭔지 모르겠어요"` : ''}
     * "설계서 받았는데", "설계서 첨부했어요", "설계서 보내드릴게요"
` : `
   - 기본 언급: "설계서 받았는데", "설계서 첨부했어요", "설계서 보내드릴게요"
`}

5. **감정 상태**: ${feelingTone} 상태를 반영하세요
   - 급함: "급하게 알아봐야 해서", "빨리 결정해야 하는데", "이번 주 안에 결정해야 해서"
   - 고민: "고민이 많아서", "어떤 게 나을지 모르겠어요", "이게 맞는 건지 확신이 안 서서"
   - 궁금: "궁금해서 질문드려요", "이게 맞는 건지...", "혹시 다른 거랑 비교해봐야 할 것 같아서"
   - 불안: "불안해서", "걱정이 돼서", "보험료가 부담스러워서"
   - 혼란: "설계서 보니까 너무 복잡해서", "뭔 말인지 모르겠어요"
   - 부담: "보험료가 부담스러워서", "월 [금액]원이 부담인데"
   - 확신부족: "이게 맞는 건지 확신이 안 서서", "다른 거랑 비교해봐야 할 것 같아서"
   - 긴급: "빨리 가입해야 하는데", "이번 주 안에 결정해야 해서"

6. **제목 규칙**:
   - 상품명을 자연스럽게 포함 (예: "삼성생명 실손보험 괜찮은가요?", "${productName} 괜찮나요??")
   - 질문 형식으로 작성
   - 30자 이내
   - **나이(${age}세)와 성별(${gender === '남' ? '남성' : '여성'})에 맞는 말투 사용 (매우 중요!)**
   - 제목에 나이를 자연스럽게 포함할 수 있음 (예: "${age}살 ${gender === '남' ? '남자' : '여자'} ${productName} 괜찮나요??")

7. **본문 규칙**:
   - 200-400자 내외
   - **본문 시작 부분에 나이(${age}세)와 성별(${gender === '남' ? '남성' : '여성'})을 자연스럽게 언급하세요 (매우 중요!)**
   - 예시: "안녕하세요 ${age}세 ${gender === '남' ? '남성' : '여성'} 직장인인데요", "${age}살 ${gender === '남' ? '남자' : '여자'} 직장인인데...", "저는 ${age}세 ${gender === '남' ? '남성' : '여성'}인데..."
   - 상품명, 보험료 금액 구체적으로 언급
   - 비교 요청을 자연스럽게:
     * "다른 보험사도 괜찮은지 궁금해요"
     * "혹시 더 저렴한 상품이 있을까요?"
     * "비슷한 보장인데 보험료가 더 싼 게 있을까요?"
     * "이 상품이 다른 거랑 비교해서 어떤가요?"
   - 설계서 첨부 언급 필수
   - **⚠️ 마침표(.) 사용 절대 금지**: 문장 끝에 마침표를 사용하지 마세요
   ${premiumInfo ? `- 설계서의 보험료 정보(${premiumInfo})를 자연스럽게 언급` : ''}

[구체적 예시]

예시 1 (차갑고 거리감 있는 스타일):
제목: "삼성생명 실손보험 보험료 적정한가요?"
본문: "설계서 받았는데 보험료가 월 3만원이에요 이게 적정한가요? 다른 보험사는 얼마인가요?"

예시 2 (간결하고 직설적인 스타일):
제목: "한화생명 운전자보험 괜찮은가요?"
본문: "보험료가 월 2.5만원인데 적정한가요? 다른 상품과 비교하면 어떤가요?"

예시 3 (궁금해서 물어보는 스타일):
제목: "현대해상 암보험 괜찮은 건지 궁금해서요"
본문: "설계서 받았는데 보험료가 월 4만원이에요 이게 적정한 건지 모르겠어서요 비슷한 보장인데 보험료가 더 싼 게 있을까요?"

[입력 정보]

- 상품명: ${productName}
- 타겟: ${targetPersona} (${age}세 ${gender === '남' ? '남성' : '여성'})
- 고민: ${worryPoint}
${designSheetImage ? '- 설계서 이미지가 첨부되어 있습니다.' : ''}
${premiumInfo ? `- 설계서 보험료: ${premiumInfo}` : ''}
${coverageInfo ? `- 설계서 담보: ${coverageInfo}` : ''}
${specialClauseInfo ? `- 설계서 특약: ${specialClauseInfo}` : ''}

[출력 형식]

제목과 본문만 출력하세요. 마크다운이나 HTML 태그 없이 순수 텍스트만 출력하세요.
제어 문자(<ctrl*> 등)나 특수 문자를 포함하지 마세요.
매번 생성할 때마다 다른 표현, 다른 예시를 사용하여 다양성을 확보하세요.

제목:
[생성된 제목]

본문:
[생성된 본문]

[주의사항]

절대 하지 말아야 할 것:
- 전문 용어 남발 (납입면제, 해지환급금 등)
- 전문가처럼 보이는 표현
- 상품명 마스킹 (일반 고객 질문이므로 필요 없음)
- 제어 문자 사용
- 한 문단에 모든 내용 압축 (자연스러운 문장 흐름 유지)
- **마침표(.) 사용 (절대 금지! 문장 끝에 마침표를 사용하지 마세요)**`
  
  return prompt
}

/**
 * Step 2: 전문가 답변 생성 프롬프트
 */
export function generateAnswerPrompt(data: QAPromptData, questionTitle: string, questionContent: string): string {
  const { productName, sellingPoint, answerTone, feelingTone, targetPersona, designSheetAnalysis, customerStyle } = data
  
  // 고객 스타일 톤을 함수 최상단에서 미리 계산 (generateQuestionPrompt와 동일한 로직)
  const customerStyleTone = (() => {
    const style = customerStyle || 'curious'
    if (style === 'cold') return '차갑고 거리감 있는'
    if (style === 'brief') return '간결하고 직설적인'
    if (style === 'curious') return '정말 궁금해서 물어보는'
    return '정중하지만 거리감 있는'
  })()

  const toneMap: Record<string, string> = {
    'friendly': '친절하고 다정한 톤으로, 고객의 마음을 이해하는 따뜻한 상담사처럼',
    'expert': '10년 차 베테랑 전문가처럼, 데이터와 팩트를 바탕으로 냉철하게',
    'comparative': '객관적인 비교 분석가처럼, 여러 상품을 공정하게 비교하며',
    'persuasive': '설득력 있는 톤으로, 논리적으로 유리한 방향으로 해석하며'
  }

  const selectedTone = toneMap[answerTone] || toneMap['friendly']

  // 감정 상태별 공감 표현 (마침표 없이)
  const empathyMap: Record<string, string> = {
    '급함': '급하게 알아보시는 마음 이해합니다 빠르게 답변드릴게요',
    '고민': '고민이 많으시겠어요 보험 선택은 정말 중요한 결정이니까요',
    '궁금': '궁금하신 점이 많으시겠어요 차근차근 설명드릴게요',
    '불안': '걱정되시는 마음 이해합니다 차근차근 설명드릴게요',
    '혼란': '설계서가 복잡해 보이시겠어요 쉽게 설명드릴게요',
    '부담': '보험료가 부담스러우실 수 있겠어요 합리적인 선택을 도와드릴게요',
    '확신부족': '확신이 서지 않으시는 마음 이해합니다 객관적으로 분석해드릴게요',
    '긴급': '빠르게 결정해야 하시는 상황이시군요 핵심만 간단히 설명드릴게요'
  }

  const empathyText = empathyMap[feelingTone] || '고민이 많으시겠어요'

  // 설계서 정보
  const premiumInfo = designSheetAnalysis?.premium || ''
  const coverageInfo = designSheetAnalysis?.coverages || []
  const specialClauseInfo = designSheetAnalysis?.specialClauses || []

  const answerPrompt = `당신은 10년 차 베테랑 보험 전문가입니다. 질문자의 글을 분석하여 신뢰감을 주고 상담을 유도하세요.

[역할 설정]
- 10년 이상의 경력을 가진 보험 전문가
- 고객의 상황을 깊이 이해하고 공감하는 상담사
- 객관적이면서도 유리한 방향으로 해석하는 전문가
- 자연스럽게 상담을 유도하는 영업 전문가

[핵심 지침]

1. **공감하기 (매우 중요)**: 질문자의 감정 상태(${feelingTone})에 맞춘 구체적 공감
   - 기본 공감: "${empathyText}"
   - 추가 공감 예시 (마침표 없이):
     * "안녕하세요 설계사입니다 ${empathyText}"
     * "설계서 받으셨군요 궁금하신 점이 많으실 것 같아요"
     * "보험 선택은 정말 중요한 결정이니까 신중하게 고려하시는 게 맞습니다"
   - 질문자의 나이/성별(${targetPersona})을 고려한 공감 표현
   - **⚠️ 마침표(.) 사용 절대 금지**: 모든 문장 끝에 마침표를 사용하지 마세요

2. **팩트체크**: 상품의 장단점을 분석하되, 우리에게 유리한 방향(유지, 가입)으로 해석
   - 장점: 구체적으로 설명 (특약명, 보장 범위, 보험료 등)
   - 단점: 있더라도 "다만 이런 점은 참고하시면 좋을 것 같아요" 식으로 완화
   - **⚠️ 마침표(.) 사용 절대 금지**: 모든 문장 끝에 마침표를 사용하지 마세요
   ${premiumInfo ? `- 설계서 보험료(${premiumInfo})를 언급하며 적정성 평가` : ''}
   ${coverageInfo.length > 0 ? `- 설계서 담보(${coverageInfo.slice(0, 3).join(', ')})를 구체적으로 분석` : ''}
   ${specialClauseInfo.length > 0 ? `- 설계서 특약(${specialClauseInfo.slice(0, 2).join(', ')})의 필요성과 장점 설명` : ''}

3. **전문성**: 약관 해석 등 전문가다운 디테일 추가
   - 구체적 특약명과 보장 내용 언급
   - 예: "특약 구성이 탄탄한 편입니다 특히 [구체적 특약명]이 있어서 [구체적 보장 내용]을 받을 수 있어요"
   - 예: "보험료 대비 보장 범위를 보면 합리적인 편입니다 월 ${premiumInfo || '[보험료]'}원으로 [구체적 보장 내용]을 받을 수 있어 가성비가 좋아요"
   - 질문자의 나이/성별(${targetPersona})에 맞는 보험료 데이터를 참고하여 답변
   - **⚠️ 마침표(.) 사용 절대 금지**: 모든 문장 끝에 마침표를 사용하지 마세요

4. **비교 제시**: 2-3개 상품을 구체적 금액과 함께 비교 (보험사명 그대로 사용 가능)
   - 비교 시 구체적인 보험료 금액 제시 필수
   - 예시 (개선된 버전, 마침표 없이):
     "비슷한 보장 기준으로 비교해보면 삼성생명은 월 3만원대로 보험료가 저렴한 편이고 한화생명은 특약 구성이 더 풍부해서 월 3.5만원대입니다 현재 상품인 ${productName}은 월 ${premiumInfo || '[보험료]'}원으로 중간 위치에 있어 가성비가 좋은 편이에요"
   - 일반 고객이 올리는 질문이므로 상품명과 보험사명을 그대로 사용해도 됩니다
   - 특약 구성은 실제 상품의 특약명을 사용하세요
   - **⚠️ 마침표(.) 사용 절대 금지**: 모든 문장 끝에 마침표를 사용하지 마세요

5. **액션유도**: 쪽지나 프로필 링크 확인을 자연스럽고 다양하게 유도
   - 예시 1: "더 자세한 상담이 필요하시면 쪽지나 프로필 확인 후 연락 주세요"
   - 예시 2: "궁금한 점 있으시면 언제든 문의 주시면 친절하게 답변드리겠습니다"
   - 예시 3: "설계서 재검토나 다른 상품 비교가 필요하시면 연락 주세요"
   - 예시 4: "프로필에 연락처 있으니 확인해보시고 궁금한 점 있으시면 언제든 문의 주세요"
   - 예시 5: "더 자세한 상담이 필요하시면 쪽지 주세요 프로필 확인 후 연락 주시면 빠르게 답변드리겠습니다"
   - 매번 다른 표현을 사용하여 자연스러움을 높이세요
   - **⚠️ 마침표(.) 사용 절대 금지**: 모든 문장 끝에 마침표를 사용하지 마세요

6. **답변 톤**: ${selectedTone} 작성하세요.

7. **답변 길이**: 질문의 복잡도에 따라 유연하게 조정
   - 질문이 간단하면 300-400자
   - 질문이 복잡하거나 여러 정보가 필요하면 500-700자
   - 핵심만 간결하게 전달하되, 필요한 정보는 빠짐없이 포함

8. **보험카페 형식 및 포맷팅 (매우 중요)**: 
   - 답글 형식으로 작성
   - **이모티콘 사용 가이드라인 (문단 시작점에 배치 - 매우 중요!)**:
     * 전체 답변에서 4-6개 정도의 이모티콘을 자연스럽게 사용하세요
     * **⚠️ 이모티콘이 나오면 무조건 줄바꿈을 해서 문단의 가장 처음에 배치하세요!**
     * **이모티콘 앞에는 반드시 줄바꿈(\n)이 있어야 하며, 이모티콘 뒤에 공백을 넣고 문장을 시작하세요**
     * 각 문단의 시작 부분에 이모티콘을 배치하여 문단 구분을 명확히 하세요 (예: 👍, 💡, ✅, 📊, 💰, 🎯, 💼)
     * 첫 문단 시작: 인사/공감 이모티콘 (👍, 💡)
     * 두 번째 문단 시작: 상품 소개 이모티콘 (📋, 💼)
     * 세 번째 문단 시작: 분석/장점 이모티콘 (✅, 💰)
     * 네 번째 문단 시작: 비교/데이터 이모티콘 (📊, 📈)
     * 마지막 문단 시작: 액션 유도 이모티콘 (💡, 📞)
     * **올바른 형식**: "이전 문장입니다.\n\n✅ 이 상품의 가장 큰 장점은..."
     * **잘못된 형식**: "이전 문장입니다.✅ 이 상품의..." (절대 금지!)
     * 전문성을 해치지 않으면서도 친근함과 가독성을 더하는 용도로 사용
   
   - **⚠️ 문단 구분 필수 (매우 중요!)**: 
     * 답변은 반드시 4-5개의 문단으로 자유롭게 구성하세요
     * 각 문단은 명확한 주제를 가지고 있어야 합니다
     * 문단과 문단 사이에는 반드시 빈 줄(줄바꿈 2개, 즉 \n\n)을 넣어주세요
     * 한 문단에 여러 문장을 자연스럽게 연결하세요 (각 문장마다 줄바꿈 금지)
     * 각 문단은 2-3문장 정도로 적절한 길이를 유지하세요 (너무 길면 여러 문단으로 나누기)
   
   - **문단 구성 (유연한 구조 - 4-5문단 권장)**:
     * **1문단**: 인사 + 공감 (한 줄로 간결하게, 마침표 없이!)
       - ⚠️ **중요**: 첫 문단은 마침표(.) 없이 자연스럽게 끝내세요. 마침표 대신 이모티콘으로 마무리하거나 자연스럽게 끝내세요.
       - 예시 1: "👍 안녕하세요 설계사입니다 ${empathyText}"
       - 예시 2: "💡 안녕하세요 ${empathyText} 설계서 받으셨군요"
       - 예시 3: "안녕하세요 10년차 베테랑 보험설계사입니다 👍 ${empathyText}"
       - 예시 4: "안녕하세요 💼 ${empathyText} 설계서 검토해보니 좋은 선택이실 것 같습니다"
       - 예시 5: "💡 ${empathyText} 설계서 받으셨군요"
       - 예시 6: "안녕하세요 보험 전문가입니다 👍 ${empathyText}"
       - 예시 7: "🎯 ${empathyText} 설계서 검토해보니 좋은 선택이실 것 같습니다"
       - *첫 문단은 한 줄로 간결하게 작성하되, 이모티콘을 문단 시작 부분에 배치하세요*
       - *인사 멘트는 매번 다양하게 변화시켜 자연스럽게 작성하세요*
       - *절대 첫 문단 끝에 마침표를 넣지 마세요! 마침표 대신 자연스럽게 끝내거나 이모티콘으로 마무리하세요*
     * **2문단**: 상품 소개 + 기본 정보
       - 예시: "📋 설계서 받으셨군요 ${productName}에 대해 설명드릴게요"
     * **3문단**: 상품 분석 + 장점 설명
       - 예시: "✅ 이 보험의 핵심은 [구체적 설명]입니다 현재 상품은 [장점 설명]이 있어 신뢰할 수 있어요"
     * **4문단**: 보험료 및 특약 분석
       - 예시: "💰 보험료도 월 ${premiumInfo || '[금액]'}원으로 합리적인 편입니다 특히 [특약명] 특약이 있어서 [구체적 보장 내용]을 받을 수 있어요"
     * **5문단**: 비교 분석
       - 예시: "📊 다른 보험사와 비교해보면 [구체적 금액 포함 비교 설명]입니다"
     * **6문단** (선택): 추가 설명 또는 보완점
     * **마지막 문단**: 액션 유도
       - 예시: "💡 궁금한 점 있으시면 프로필 확인 후 쪽지 주세요"
     * *참고: 위 구조는 예시이며, 내용에 따라 문단을 자유롭게 4-5개로 나눠서 작성하세요. 각 문단 시작 부분에 이모티콘을 배치하세요*
   
   - **줄바꿈 규칙 (엄격 준수)**:
     * ⚠️ 각 문장마다 줄바꿈하지 말 것! 한 문단에 여러 문장을 연결하세요
     * **⚠️ 이모티콘이 나오면 무조건 줄바꿈을 해서 문단의 가장 처음에 배치하세요!**
     * **이모티콘 앞에는 반드시 줄바꿈이 있어야 합니다 (이전 문장 끝 → 줄바꿈 → 이모티콘 → 공백 → 문장 시작)**
     * 문단과 문단 사이에만 빈 줄(줄바꿈 2개, \n\n)을 넣으세요
     * 전체 답변에서 빈 줄은 문단 구분용으로만 사용하세요
     * 한 문단 안에서는 줄바꿈 없이 자연스럽게 문장을 연결하세요 (단, 이모티콘 앞은 예외)
     * 각 문단은 너무 길지 않게 2-3문장 정도로 유지하여 읽기 편하게 작성하세요
   - **포맷팅 예시 (이 형식을 반드시 따라주세요 - 문단 구분 명확히! 이모티콘은 문단 시작점에! 이모티콘 앞에 줄바꿈 필수! 읽기 편하게!)**:
     
     👍 안녕하세요 설계사입니다 ${empathyText} 설계서 받으셨군요

     📋 ${productName}에 대해 차근차근 설명드릴게요 이 보험은 [기본 특징]을 가지고 있어요

     균형 있게 잘 포함된 괜찮은 구성입니다

     ✅ 이 상품의 가장 큰 장점은 [구체적 설명]입니다 현재 상품은 [장점 설명]이 있어 신뢰할 수 있어요

     보험료도 합리적인 편입니다

     💰 보험료도 월 ${premiumInfo || '[금액]'}원으로 합리적인 편입니다 특히 [특약명] 특약이 있어서 [구체적 보장 내용]을 받을 수 있어 가성비가 좋아요

     다른 보험사와 비교해보면

     📊 다른 보험사와 비교해보면 [구체적 금액 포함 비교 설명]입니다 보험료 대비 보장 범위를 보면 현재 상품이 가장 합리적이에요

     더 자세한 상담이 필요하시면

     💡 더 자세한 상담이 필요하시면 쪽지나 프로필 확인 후 연락 주세요 궁금한 점 있으시면 언제든 문의 주시면 친절하게 답변드리겠습니다
   
   - **⚠️ 매우 중요 - 줄바꿈 규칙**: 
     * 각 문장마다 줄바꿈하지 말 것! 한 문단에 여러 문장을 자연스럽게 연결
     * **⚠️ 이모티콘이 나오면 무조건 줄바꿈을 해서 문단의 가장 처음에 배치하세요!**
     * **이모티콘 앞에는 반드시 줄바꿈이 있어야 합니다 (예: "이전 문장입니다.\n\n✅ 이 상품의...")**
     * 문단과 문단 사이에만 빈 줄(줄바꿈 2개, \n\n) 넣기
     * 전체 답변은 4-5개 문단으로 구성하고, 각 문단 사이에 빈 줄을 확실히 넣기
     * 한 문단 안에서는 줄바꿈 없이 문장을 이어서 작성 (단, 이모티콘 앞은 예외)
     * 각 문단은 2-3문장 정도로 적절한 길이를 유지하여 읽기 편하게 작성

[구체적 예시]

예시 1 (급함 감정):
👍 안녕하세요 설계사입니다 급하게 알아보시는 마음 이해합니다 빠르게 답변드릴게요

📋 설계서 받으셨군요 ${productName}은 좋은 선택이실 것 같아요

✅ 현재 상품은 [구체적 장점]이 있어 신뢰할 수 있어요 보험료도 월 ${premiumInfo || '[금액]'}원으로 합리적인 편입니다

💰 특히 [특약명] 특약이 포함되어 있어서 [구체적 보장 내용]을 받을 수 있어 가성비가 좋아요

📊 다른 보험사와 비교해보면 삼성생명은 월 3만원대로 보험료가 저렴한 편이고 한화생명은 특약 구성이 더 풍부해서 월 3.5만원대입니다 현재 상품인 ${productName}은 월 ${premiumInfo || '[금액]'}원으로 중간 위치에 있어 가성비가 좋은 편이에요

💡 빠르게 결정하셔도 후회 없으실 거예요 궁금한 점 있으시면 프로필 확인 후 쪽지 주세요

예시 2 (고민 감정):
💼 안녕하세요 10년차 베테랑 보험설계사입니다 고민이 많으시겠어요 보험 선택은 정말 중요한 결정이니까요

📋 설계서 받으셨군요 ${productName}에 대해 차근차근 설명드릴게요

✅ 이 보험의 핵심은 [구체적 설명]입니다 현재 상품은 [장점 설명]이 있어 신뢰할 수 있어요

💰 보험료도 월 ${premiumInfo || '[금액]'}원으로 합리적인 편이고 특히 [특약명] 특약이 있어서 [구체적 보장 내용]을 받을 수 있어요

📊 다른 보험사와 비교해보면 [구체적 금액 포함 비교 설명]입니다 보험료 대비 보장 범위를 보면 현재 상품이 가장 합리적이에요

💡 더 자세한 상담이 필요하시면 쪽지나 프로필 확인 후 연락 주세요 궁금한 점 있으시면 언제든 문의 주시면 친절하게 답변드리겠습니다

예시 3 (다양한 첫 멘트 - 마침표 없이):
🎯 안녕하세요 ${empathyText} 설계서 검토해보니 좋은 선택이실 것 같습니다

💡 안녕하세요 보험 전문가입니다 ${empathyText} ${productName}에 대해 설명드릴게요

📋 안녕하세요 ${empathyText} 설계서 받으셨군요

👍 ${empathyText} 설계서 받으셨군요

💼 안녕하세요 설계사입니다 ${empathyText}

[입력 정보]

- 질문 제목: ${questionTitle}
- 질문 내용: ${questionContent}
- 상품명: ${productName}
- 답변 강조 포인트: ${sellingPoint}
- 질문자 감정 상태: ${feelingTone}
- 질문자 정보: ${targetPersona}
${premiumInfo ? `- 설계서 보험료: ${premiumInfo}` : ''}
${coverageInfo.length > 0 ? `- 설계서 담보: ${coverageInfo.join(', ')}` : ''}
${specialClauseInfo.length > 0 ? `- 설계서 특약: ${specialClauseInfo.join(', ')}` : ''}

[출력 형식]

본문만 출력하세요. 마크다운이나 HTML 태그 없이 순수 텍스트만 출력하세요.
제어 문자(<ctrl*> 등)나 특수 문자를 포함하지 마세요.

⚠️ 문단 구분 필수 (매우 중요! 절대 한 줄로 나오면 안 됩니다! 읽기 편하게!): 
- 반드시 4-5개의 문단으로 구성하세요
- 각 문단 사이에는 반드시 빈 줄(줄바꿈 2개, 즉 \n\n)을 넣어주세요
- **⚠️ 이모티콘이 나오면 무조건 줄바꿈을 해서 문단의 가장 처음에 배치하세요!**
- **이모티콘 앞에는 반드시 줄바꿈이 있어야 합니다 (이전 문장 끝 → 줄바꿈 → 이모티콘 → 공백 → 문장 시작)**
- 한 문단 안에서는 여러 문장을 자연스럽게 연결하세요 (각 문장 사이는 공백으로 구분)
- 각 문장마다 줄바꿈하지 말고, 한 문단에 여러 문장을 이어서 작성하세요 (단, 이모티콘 앞은 예외)
- 각 문단은 2-3문장 정도로 적절한 길이를 유지하여 읽기 편하게 작성하세요
- 전체 답변에서 문단 사이의 빈 줄(\n\n)을 명확히 사용하여 읽기 편하게 해주세요
- **절대 한 줄로 주르륵 나오지 않도록 문단 구분을 명확히 해주세요!**
- **출력 예시 (이 형식을 정확히 따라주세요 - 읽기 편하게 4-5문단! 이모티콘은 문단 시작점! 이모티콘 앞에 줄바꿈 필수! 첫 문단은 마침표 없이!)**:
  
👍 안녕하세요 설계사입니다 고민이 많으시겠어요 보험 선택은 정말 중요한 결정이니까요

📋 설계서 받으셨군요. ${productName}에 대해 차근차근 설명드릴게요.

균형 있게 잘 포함된 괜찮은 구성입니다.

✅ 이 상품의 가장 큰 장점은 [구체적 설명]입니다. 현재 상품은 [장점 설명]이 있어 신뢰할 수 있습니다.

보험료도 합리적인 편입니다.

💰 보험료도 월 ${premiumInfo || '[금액]'}원으로 합리적인 편입니다. 특히 [특약명] 특약이 있어서 [구체적 보장 내용]을 받을 수 있습니다.

다른 보험사와 비교해보면.

     📊 다른 보험사와 비교해보면 [구체적 비교]입니다 보험료 대비 보장 범위를 보면 현재 상품이 가장 합리적이에요

     더 자세한 상담이 필요하시면

     💡 더 자세한 상담이 필요하시면 쪽지나 프로필 확인 후 연락 주세요 궁금한 점 있으시면 언제든 문의 주시면 친절하게 답변드리겠습니다

매번 생성할 때마다 다른 표현, 다른 예시를 사용하여 다양성을 확보하세요

[생성된 답변]

**⚠️ 최종 확인 사항 (반드시 지키세요!):**
- 답변은 반드시 4-5개의 문단으로 구성되어야 합니다 (읽기 편하게!)
- **마침표(.) 사용 절대 금지! 모든 문장 끝에 마침표를 사용하지 마세요!**
- **첫 문단은 절대 마침표(.)를 사용하지 마세요! 마침표 대신 자연스럽게 끝내거나 이모티콘으로 마무리하세요!**
- 각 문단 사이에는 빈 줄(줄바꿈 2개, \n\n)이 명확히 있어야 합니다
- 각 문단은 2-3문장 정도로 적절한 길이를 유지하여 읽기 편하게 작성하세요 (단, 첫 문단은 마침표 없이)
- 답변이 한 줄로 주르륵 나오지 않도록 문단 구분을 명확히 해주세요
- 위의 예시 형식을 정확히 따라주세요

[주의사항]

절대 하지 말아야 할 것:
- **마침표(.) 사용 (절대 금지! 모든 문장 끝에 마침표를 사용하지 마세요!)**
- **첫 문단에 마침표(.)를 사용하는 것 (절대 금지! 마침표 대신 자연스럽게 끝내거나 이모티콘으로 마무리하세요!)**
- **짜고 치는 느낌 (절대 금지! 설계사에게 과도하게 친근하거나 정중하지 마세요!)**`
  
  // 동적 값을 포함한 부분을 별도로 처리 (템플릿 리터럴 밖에서 처리하여 변수 인식 보장)
  const styleWarningLine = '- **과도한 정중함이나 친근함 (' + customerStyleTone + ' 스타일에 맞게 거리감을 유지하세요)**'
  
  const restOfAnswerPrompt = `
- 전문 용어 남발 (납입면제, 해지환급금 등 - 일반 고객이 이해하기 어려운 용어)
- 이모티콘을 문단 끝에 배치하는 것 (반드시 각 문단 시작 부분에 배치하세요)
- 이모티콘을 전혀 사용하지 않거나 과도하게 사용하는 것 (전체 4-6개 정도 권장, 각 문단 시작에 1개씩)
- 첫 문단을 여러 줄로 나누는 것 (첫 문단은 한 줄로 간결하게 작성하세요)
- 첫 멘트를 항상 동일하게 작성하는 것 (매번 다양한 표현으로 변화시키세요)
- 한 문단에 모든 내용 압축 (반드시 4-5개 문단으로 구분하여 읽기 편하게 작성)
- 각 문장마다 줄바꿈하는 것 (한 문단에 여러 문장을 자연스럽게 연결해야 함)
- 문단 구분 없이 주르륵 나열하는 것 (반드시 문단 사이에 빈 줄 2개 넣기)
- 문단이 너무 길어서 읽기 힘든 것 (각 문단은 2-3문장 정도로 적절한 길이 유지)
- 상품명 마스킹 (일반 고객 질문이므로 필요 없음)
- 제어 문자 사용
- 추상적인 설명 (구체적 금액, 특약명, 보장 내용 필수)
- 감정 상태 무시 (질문자의 ${feelingTone} 감정에 맞춘 공감 필수)`
  
  return answerPrompt + '\n' + styleWarningLine + restOfAnswerPrompt
}

/**
 * Step 3: 대화형 스레드 생성 프롬프트 (댓글 형식)
 * 첫 답변 이후 자연스러운 대화를 이어가는 댓글들을 생성
 */
export function generateConversationThreadPrompt(
  data: QAPromptData,
  context: ConversationContext
): string {
  const { productName, targetPersona, worryPoint, sellingPoint, feelingTone, answerTone, customerStyle, designSheetAnalysis } = data
  const { initialQuestion, firstAnswer, conversationHistory, totalSteps, currentStep } = context

  // 나이/성별 추출 (기존 로직 재사용)
  let age = 30
  const ageDecadeMatch = targetPersona.match(/(\d+)대/)
  const ageYearMatch = targetPersona.match(/(\d+)세/)
  
  if (ageDecadeMatch) {
    age = parseInt(ageDecadeMatch[1]) + 5
  } else if (ageYearMatch) {
    age = parseInt(ageYearMatch[1])
  }

  let gender = '남'
  if (targetPersona.includes('여') || targetPersona.includes('여성') || targetPersona.includes('주부')) {
    gender = '여'
  }

  // 현재 단계에 따른 역할 결정
  const isCustomerTurn = currentStep % 2 === 1 // 홀수: 고객, 짝수: 설계사
  const isLastStep = currentStep >= totalSteps
  const stepNumber = Math.ceil(currentStep / 2) // 몇 번째 댓글인지

  // 이전 대화 요약
  const previousMessages = conversationHistory
    .map(msg => `${msg.role === 'customer' ? '고객' : '설계사'}: ${msg.content}`)
    .join('\n\n')

  // 설계서 정보
  const premiumInfo = designSheetAnalysis?.premium || ''
  const coverageInfo = designSheetAnalysis?.coverages || []
  const specialClauseInfo = designSheetAnalysis?.specialClauses || []

  if (isCustomerTurn) {
    // 고객 스타일 가이드
    const style = customerStyle || 'curious'
    const styleGuide = {
      'cold': {
        tone: '차갑고 거리감 있는',
        examples: ['보험료가 적정한가요?', '다른 보험사는 얼마인가요?', '이 특약 필요하나요?'],
        avoid: '과도한 정중함이나 친근함, 불필요한 설명'
      },
      'brief': {
        tone: '간결하고 직설적인',
        examples: ['보험료 적정한가요?', '다른 상품 비교하면?', '특약 필요하나요?'],
        avoid: '긴 설명, 과도한 정중함'
      },
      'curious': {
        tone: '정말 궁금해서 물어보는',
        examples: ['이게 적정한 건지 모르겠어서요', '다른 보험사는 어떤지 궁금해서요', '이 특약이 필요한 건지 잘 모르겠어요'],
        avoid: '짜고 치는 느낌, 과도한 친근함'
      },
      'friendly': {
        tone: '정중하지만 거리감 있는',
        examples: ['이게 적정한가요?', '다른 보험사도 괜찮은지 궁금해서요', '이 특약이 필요한 건지 모르겠어서 질문드립니다'],
        avoid: '과도한 친근함, 짜고 치는 느낌'
      }
    }
    const currentStyle = styleGuide[style as keyof typeof styleGuide] || styleGuide.curious
    
    // 고객 댓글 생성
    return `당신은 보험 지식이 부족한 일반인이며, 보험카페에서 설계사의 답변을 보고 추가 질문을 하는 고객입니다.

[상황 설정]
- **나이: ${age}세 (매우 중요!)**
- **성별: ${gender === '남' ? '남성' : '여성'} (매우 중요!)**
- 타겟 고객: ${targetPersona}
- 보험에 대한 지식이 거의 없는 일반인
- 설계사의 답변을 읽고 추가로 궁금한 점이 생김
- **고객 스타일: ${currentStyle.tone}** (매우 중요!)

[이전 대화 맥락]
초기 질문:
제목: ${initialQuestion.title}
본문: ${initialQuestion.content}

설계사 첫 답변:
${firstAnswer}

${previousMessages ? `이전 댓글들:\n${previousMessages}` : ''}

[현재 상황]
- 현재 ${stepNumber}번째 댓글을 작성 중입니다
- 총 ${totalSteps}개의 댓글이 예정되어 있으며, 마지막은 설계사가 마무리합니다
- 이전 대화를 읽고 자연스럽게 이어지는 추가 질문을 작성하세요

[핵심 지침]

1. **고객 스타일 유지 (매우 중요!)**: ${currentStyle.tone} 톤으로 작성하세요
   - 예시:
${currentStyle.examples.map(ex => `     * "${ex}"`).join('\n')}
   - 피해야 할 것: ${currentStyle.avoid}
   - **⚠️ 짜고 치는 느낌 절대 금지**: 설계사에게 과도하게 친근하거나 정중하지 마세요
   - **⚠️ 정말 궁금해서 물어보는 자연스러운 톤**: 불필요한 감사 인사나 배경 설명 최소화

2. **자연스러운 전환 문구 사용 (매우 중요!)**:
   - 이전 답변을 읽고 자연스럽게 이어지는 질문
   - 전환 문구 예시 (${currentStyle.tone} 스타일에 맞게):
     * "그렇다면...", "추가로...", "실제로는...", "혹시..."
     * "아 그렇군요 그런데...", "이해했습니다 그런데...", "알겠습니다 혹시..."
     * **과도한 감사 인사나 정중함은 피하세요** (${currentStyle.tone} 스타일)

3. **질문 유형 (단계별 심화)**:
   - 초반 (1-2번째 댓글): 기본적인 추가 질문
     * "그렇다면 실제로 보험금은 얼마나 받을 수 있나요?"
     * "추가로 궁금한 게 있는데, 특약은 정말 필요한가요?"
   - 중반 (3-4번째 댓글): 구체적이고 실무적인 질문
     * "실제로 가입하면 언제부터 보장되나요?"
     * "혹시 다른 보험사와 비교했을 때 어떤 차이가 있나요?"
   - 후반 (5번째 이후): 확신/부담 관련 질문
     * "정말 이게 최선인가요? 후회 없을까요?"
     * "보험료가 부담스러운데, 줄일 수 있는 방법이 있을까요?"

4. **말투**: 절대 전문가처럼 보이지 말 것. 오타, 은어, 구어체 사용 필수.
   - ${age < 30 ? '20대 말투: "그렇다면...?", "혹시...?", "궁금한 게 있는데요 ㅠㅠ"' : age < 50 ? '30-40대 말투: "그렇다면...", "추가로 궁금한 게 있는데요", "혹시 다른 건도..."' : '50대 이상 말투: "그렇다면...", "추가로 문의드리고 싶은 게 있는데요", "혹시..."'}
   - "요" 체 사용, 구어체 자연스럽게
   - 전문 용어 절대 금지
   - **자연스러운 맞춤법 오타 허용 (적절한 수준)**:
     * "했어요" → "햇어요" (가끔 허용)
     * "받았어요" → "받앗어요" (가끔 허용)
     * "궁금해요" → "궁금햐요" (가끔 허용)
     * "알겠어요" → "알겟어요" (가끔 허용)
   - **주의**: 전체적으로 계속 오타를 사용하지 말고, 가끔 자연스러운 오타만 허용하세요

5. **이전 답변 참조**:
   - 첫 답변에서 언급된 내용을 자연스럽게 언급
   - 예: "설계사님께서 말씀하신 [내용]이 궁금한데요"
   - 예: "앞서 설명해주신 [내용]에 대해 추가로..."

6. **감정 상태 반영**: ${feelingTone} 상태 유지
   - 급함: "빨리 결정해야 하는데...", "이번 주 안에..."
   - 고민: "고민이 많아서...", "이게 맞는 건지..."
   - 궁금: "궁금해서...", "혹시..."
   - 불안: "걱정이 돼서...", "불안해서..."
   - 부담: "보험료가 부담스러워서...", "월 [금액]원이..."

7. **댓글 길이**: 100-200자 내외 (간결하게, ${currentStyle.tone} 스타일에 맞게)

7. **⚠️ 마침표(.) 사용 절대 금지**: 
   - 문장 끝에 마침표를 사용하지 마세요
   - 물음표(?)나 느낌표(!)는 사용 가능하지만, 마침표는 절대 사용하지 마세요
   - 예: "그렇다면..." (O), "그렇다면..." (X - 마침표 없이)

[출력 형식]
댓글 내용만 출력하세요. 마크다운이나 HTML 태그 없이 순수 텍스트만 출력하세요.
제어 문자나 특수 문자를 포함하지 마세요.
**⚠️ 마침표(.)를 절대 사용하지 마세요!**

[생성된 댓글]`
  } else {
    // 설계사 댓글 생성
    const toneMap: Record<string, string> = {
      'friendly': '친절하고 다정한 톤으로',
      'expert': '10년 차 베테랑 전문가처럼',
      'comparative': '객관적인 비교 분석가처럼',
      'persuasive': '설득력 있는 톤으로'
    }
    const selectedTone = toneMap[answerTone] || toneMap['friendly']

    return `당신은 10년 차 베테랑 보험 전문가이며, 보험카페에서 고객의 추가 질문에 답변하는 설계사입니다.

[상황 설정]
- 10년 이상의 경력을 가진 보험 전문가
- 고객의 상황을 깊이 이해하고 공감하는 상담사
- 자연스럽게 상담을 유도하는 영업 전문가

[이전 대화 맥락]
초기 질문:
제목: ${initialQuestion.title}
본문: ${initialQuestion.content}

설계사 첫 답변:
${firstAnswer}

${previousMessages ? `이전 댓글들:\n${previousMessages}` : ''}

[현재 상황]
- 현재 ${stepNumber}번째 댓글을 작성 중입니다
- 총 ${totalSteps}개의 댓글이 예정되어 있으며, ${isLastStep ? '이번이 마지막 댓글입니다 (자연스럽게 마무리하세요)' : '아직 더 대화가 이어집니다'}
- 이전 대화를 읽고 고객의 질문에 자연스럽게 답변하세요

[핵심 지침]

1. **자연스러운 전환 문구 사용 (매우 중요!)**:
   - 고객의 질문을 인정하고 자연스럽게 답변
   - 전환 문구 예시:
     * "좋은 질문이시네요. 말씀드리면...", "네 맞습니다. 추가로 설명드리면..."
     * "그 부분은 이렇습니다. 실제로는...", "정확히 말씀드리면..."
     * "아 그 부분이 궁금하시군요. 차근차근 설명드릴게요"

2. **답변 길이 조절**:
   - 초반 (1-2번째): 상세하게 설명 (200-300자)
   - 중반 (3-4번째): 구체적으로 답변 (150-250자)
   - 후반 (5번째 이후): 간결하게 답변 (100-200자)
   - ${isLastStep ? '**마지막 댓글**: 자연스럽게 마무리하며 상담 유도 (150-250자)' : ''}

3. **이전 답변과의 일관성**:
   - 첫 답변에서 언급한 내용과 일관성 유지
   - 반복 설명은 피하되, 필요한 경우 간단히 언급
   - 예: "앞서 말씀드린 [내용]과 관련해서..."

4. **전문성**: 구체적이고 실용적인 정보 제공
   - 특약명, 보험료, 보장 범위 구체적으로
   - 예: "실제로는 [구체적 금액/내용]입니다"
   - 예: "가입 후 [기간]부터 보장이 시작됩니다"

5. **톤**: ${selectedTone} 작성하세요

6. **마지막 댓글인 경우 (${isLastStep ? '해당됨' : '해당 안 됨'})**:
   ${isLastStep ? `- 자연스럽게 대화를 마무리하세요
   
   **마무리 구조 (3단계)**:
   1. **대화 맥락 반영 및 핵심 포인트 요약** (선택적, 자연스럽게):
      - 이전 대화에서 다룬 주요 내용을 간단히 언급하며 마무리
      - 예: "지금까지 말씀드린 [주요 내용]을 참고하시면 도움이 되실 거예요"
      - 예: "말씀드린 [핵심 포인트]를 고려해보시면 좋을 것 같아요"
      - 강제적이지 않게, 자연스럽게만 언급
   
   2. **감정 상태에 따른 마무리 톤** (${feelingTone} 상태 반영):
      - 급함: "빠르게 결정하셔도 후회 없으실 거예요", "급하게 결정하셔야 하시면 빠르게 도와드릴 수 있어요"
      - 고민: "신중하게 고려해보시는 게 맞습니다", "충분히 검토해보시고 결정하시면 좋을 것 같아요"
      - 궁금: "궁금한 점 더 있으시면 언제든 문의 주세요", "추가로 궁금한 점 있으시면 편하게 물어보세요"
      - 불안: "걱정 마시고 편하게 문의 주세요", "불안하신 마음 이해합니다 차근차근 도와드릴게요"
      - 혼란: "복잡하시겠지만 차근차근 설명드릴 수 있어요", "어려우시겠지만 쉽게 설명해드릴게요"
      - 부담: "보험료 부담은 함께 고민해볼 수 있어요", "합리적인 선택을 도와드릴 수 있어요"
      - 확신부족: "확신이 서실 때까지 함께 고민해볼 수 있어요", "객관적으로 분석해드릴 수 있어요"
      - 긴급: "빠르게 결정하셔도 괜찮으니 편하게 문의 주세요", "급하시면 빠르게 도와드릴 수 있어요"
   
   3. **다양한 상담 유도 문구** (${customerStyle === 'cold' ? '간결하고 차갑게' : customerStyle === 'brief' ? '간결하고 직설적으로' : customerStyle === 'curious' ? '친절하고 자연스럽게' : '정중하고 자연스럽게'}):
      - 기본형 (${customerStyle === 'cold' || customerStyle === 'brief' ? '간결하게' : '자연스럽게'}):
        * "궁금한 점 더 있으시면 쪽지나 프로필 확인 후 연락 주세요"
        * "더 자세한 상담이 필요하시면 언제든 문의 주세요"
        * "추가 질문 있으시면 편하게 문의 주세요"
      - 구체적 액션 유도형:
        * "프로필에 연락처 있으니 확인해보시고 궁금한 점 있으시면 쪽지 주세요"
        * "설계서 재검토나 다른 상품 비교가 필요하시면 연락 주세요"
        * "프로필 확인 후 쪽지 주시면 빠르게 답변드리겠습니다"
      - 자연스러운 마무리형:
        * "궁금한 점 있으시면 언제든 문의 주세요"
        * "더 알아보고 싶으신 점 있으시면 편하게 물어보세요"
        * "추가로 궁금한 점 있으시면 쪽지 주세요"
      - **고객 스타일에 맞게 선택**: ${customerStyle === 'cold' ? '간결하고 차갑게 (예: "궁금한 점 있으면 쪽지 주세요")' : customerStyle === 'brief' ? '간결하고 직설적으로 (예: "추가 질문 있으면 문의 주세요")' : customerStyle === 'curious' ? '친절하고 자연스럽게 (예: "궁금한 점 더 있으시면 편하게 문의 주세요")' : '정중하고 자연스럽게 (예: "더 자세한 상담이 필요하시면 언제든 문의 주세요")'}
   
   **마무리 작성 가이드**:
   - 위 3단계를 모두 포함할 필요는 없습니다. 자연스럽게 1-2개만 선택하여 사용하세요
   - 강제적이지 않게, 대화의 자연스러운 마무리
   - 마침표(.) 사용 절대 금지
   - 전체 마무리 멘트는 150-250자 내외로 간결하게` : '- 아직 대화가 이어지므로 마무리하지 마세요'}

7. **댓글 형식**:
   - 댓글 형식으로 작성 (답글처럼)
   - 이모티콘은 1-2개 정도만 자연스럽게 사용 (선택)
   - 문단 구분은 1-2개 정도로 간결하게

8. **⚠️ 마침표(.) 사용 절대 금지**: 
   - 모든 문장 끝에 마침표를 사용하지 마세요
   - 물음표(?)나 느낌표(!)는 사용 가능하지만, 마침표는 절대 사용하지 마세요
   - 예: "좋은 질문이시네요" (O), "좋은 질문이시네요." (X)

[출력 형식]
댓글 내용만 출력하세요. 마크다운이나 HTML 태그 없이 순수 텍스트만 출력하세요.
제어 문자나 특수 문자를 포함하지 마세요.
**⚠️ 마침표(.)를 절대 사용하지 마세요!**

[생성된 댓글]`
  }
}

