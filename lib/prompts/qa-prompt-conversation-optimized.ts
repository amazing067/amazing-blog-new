/**
 * 대화형 스레드 생성 프롬프트 - 고급 최적화 버전
 * 
 * 원본: lib/prompts/qa-prompt.ts의 generateConversationThreadPrompt 함수
 * 최적화 일자: 2025-01-XX
 * 
 * 고급 최적화 전략 적용:
 * - Step별 맥락 요약 (Step 3: 전체, Step 4-6: 요약, Step 7-12: 최소)
 * - 반복적인 종결어미 금지 ("궁금해요", "궁금햐요" 등)
 * 
 * 언제든지 이 파일의 내용으로 최적화 버전으로 복원 가능
 */

import { QAPromptData, ConversationContext } from './qa-prompt'

/**
 * 맥락 요약 함수 (고급 최적화 전략)
 * Step별로 다른 수준의 맥락 제공
 */
function formatInitialQuestionContext(
  initialQuestion: { title: string; content: string },
  currentStep: number
): string {
  // Step 3: 전체 맥락 (첫 댓글만)
  if (currentStep === 3) {
    return `제목: ${initialQuestion.title}
본문: ${initialQuestion.content}`
  }
  
  // Step 4-6: 요약 맥락 (150자)
  if (currentStep <= 6) {
    const summary = initialQuestion.content.length > 150
      ? initialQuestion.content.slice(0, 150) + '...'
      : initialQuestion.content
    return `제목: ${initialQuestion.title}
본문 요약: ${summary}`
  }
  
  // Step 7-12: 최소 맥락 (제목만)
  return `제목: ${initialQuestion.title}`
}

/**
 * 첫 답변 요약 함수 (고급 최적화 전략)
 */
function formatFirstAnswerContext(
  firstAnswer: string,
  currentStep: number
): string {
  // Step 3: 전체 답변 (첫 댓글만)
  if (currentStep === 3) {
    return firstAnswer
  }
  
  // Step 4-6: 300자 요약
  if (currentStep <= 6) {
    return firstAnswer.length > 300
      ? firstAnswer.slice(0, 300) + '...'
      : firstAnswer
  }
  
  // Step 7-12: 200자 요약
  return firstAnswer.length > 200
    ? firstAnswer.slice(0, 200) + '...'
    : firstAnswer
}

/**
 * 고급 최적화 버전 generateConversationThreadPrompt 함수
 * 이 함수는 Step별 맥락 요약과 반복 표현 제거가 적용된 최적화 버전입니다.
 */
export function generateConversationThreadPromptOptimized(
  data: QAPromptData,
  context: ConversationContext
): string {
  const { productName, targetPersona, worryPoint, sellingPoint, feelingTone, answerTone, customerStyle, designSheetAnalysis, searchResultsText } = data
  const { initialQuestion, firstAnswer, conversationHistory, totalSteps, currentStep } = context

  // 나이/성별 추출 (기존 로직 재사용)
  let age = 30
  const ageDecadeMatch = targetPersona.match(/(\d+)대/)
  const ageYearMatch = targetPersona.match(/(\d+)세/)
  
  if (ageDecadeMatch) {
    age = parseInt(ageDecadeMatch[1]) + 5
  } else if (ageYearMatch) {
    age = parseInt(ageYearMatch[1])
  }

  let gender = '남'
  if (targetPersona.includes('여') || targetPersona.includes('여성') || targetPersona.includes('주부')) {
    gender = '여'
  }

  // 현재 단계에 따른 역할 결정
  const isCustomerTurn = currentStep % 2 === 1 // 홀수: 고객, 짝수: 설계사
  const isLastStep = currentStep >= totalSteps
  const stepNumber = Math.ceil(currentStep / 2) // 몇 번째 댓글인지

  // 이전 대화 요약
  const previousMessages = conversationHistory
    .map(msg => `${msg.role === 'customer' ? '고객' : '설계사'}: ${msg.content}`)
    .join('\n\n')

  // 설계서 정보
  const premiumInfo = designSheetAnalysis?.premium || ''
  const coverageInfo = designSheetAnalysis?.coverages || []
  const specialClauseInfo = designSheetAnalysis?.specialClauses || []

  // 고급 최적화: Step별 맥락 요약
  const initialQuestionContext = formatInitialQuestionContext(initialQuestion, currentStep)
  const firstAnswerContext = formatFirstAnswerContext(firstAnswer, currentStep)

  if (isCustomerTurn) {
    // 고객 스타일 가이드
    const style = customerStyle || 'curious'
    const styleGuide = {
      'cold': {
        tone: '차갑고 거리감 있는',
        examples: ['보험료가 적정한가요?', '다른 보험사는 얼마인가요?', '이 특약 필요하나요?'],
        avoid: '과도한 정중함이나 친근함, 불필요한 설명'
      },
      'brief': {
        tone: '간결하고 직설적인',
        examples: ['보험료 적정한가요?', '다른 상품 비교하면?', '특약 필요하나요?'],
        avoid: '긴 설명, 과도한 정중함'
      },
      'curious': {
        tone: '정말 궁금해서 물어보는',
        examples: ['이게 적정한 건지 모르겠어서요', '다른 보험사는 어떤지 궁금해서요', '이 특약이 필요한 건지 잘 모르겠어요'],
        avoid: '짜고 치는 느낌, 과도한 친근함'
      },
      'friendly': {
        tone: '정중하지만 거리감 있는',
        examples: ['이게 적정한가요?', '다른 보험사도 괜찮은지 궁금해서요', '이 특약이 필요한 건지 모르겠어서 질문드립니다'],
        avoid: '과도한 친근함, 짜고 치는 느낌'
      }
    }
    const currentStyle = styleGuide[style as keyof typeof styleGuide] || styleGuide.curious
    
    // 고객 댓글 생성
    return `당신은 보험 지식이 부족한 일반인이며, 보험카페에서 설계사의 답변을 보고 추가 질문을 하는 고객입니다.

[상황 설정]
- **나이: ${age}세 (매우 중요!)**
- **성별: ${gender === '남' ? '남성' : '여성'} (매우 중요!)**
- 타겟 고객: ${targetPersona}
- 보험에 대한 지식이 거의 없는 일반인
- 설계사의 답변을 읽고 추가로 궁금한 점이 생김
- **고객 스타일: ${currentStyle.tone}** (매우 중요!)

[이전 대화 맥락]
초기 질문:
${initialQuestionContext}

설계사 첫 답변:
${firstAnswerContext}

${previousMessages ? `이전 댓글들:\n${previousMessages}` : ''}

[현재 상황]
- 현재 ${stepNumber}번째 댓글을 작성 중입니다
- 총 ${totalSteps}개의 댓글이 예정되어 있으며, 마지막은 설계사가 마무리합니다
- 이전 대화를 읽고 자연스럽게 이어지는 추가 질문을 작성하세요

[핵심 지침]

1. **고객 스타일 유지 (매우 중요!)**: ${currentStyle.tone} 톤으로 작성하세요
   - 예시:
${currentStyle.examples.map(ex => `     * "${ex}"`).join('\n')}
   - 피해야 할 것: ${currentStyle.avoid}
   - **⚠️ 짜고 치는 느낌 절대 금지**: 설계사에게 과도하게 친근하거나 정중하지 마세요
   - **⚠️ 정말 궁금해서 물어보는 자연스러운 톤**: 불필요한 감사 인사나 배경 설명 최소화

2. **자연스러운 전환 문구 사용 (매우 중요!)**:
   - 이전 답변을 읽고 자연스럽게 이어지는 질문
   - **⚠️ 반복적인 전환 문구 절대 금지**: "아 그렇군요", "아 알겠습니다", "이해했습니다" 같은 반복적인 표현 사용 금지
   - **⚠️ 반복적인 종결어미 절대 금지**: "궁금해요", "궁금햐요", "궁금합니다" 같은 표현을 연속으로 사용하지 마세요. 매번 다른 표현을 사용하세요 (예: "알고 싶어요", "확인하고 싶어요", "모르겠어요", "가능한지", "되는지", "맞나요", "적정한가요" 등)
   - **⚠️ 감사 인사나 정중함 최소화**: "감사합니다", "부탁드립니다" 같은 과도한 정중함은 피하세요 (${currentStyle.tone} 스타일에 맞게)
   - **전환 문구 다양화** (매번 다르게 선택, 총 25가지 패턴):
     * 패턴 A: "그렇다면..."
     * 패턴 B: "추가로 궁금한 게 있는데요..."
     * 패턴 C: "실제로는..."
     * 패턴 D: "혹시..."
     * 패턴 E: "그런데..."
     * 패턴 F: "그리고..."
     * 패턴 G: "또한..."
     * 패턴 H: "그리고요..."
     * 패턴 I: "그런데 한 가지 더..."
     * 패턴 J: "추가로 질문이 있는데요..."
     * 패턴 K: "그리고 궁금한 게 있어요..."
     * 패턴 L: "또 궁금한 게 있는데요..."
     * 패턴 M: "그리고요 혹시..."
     * 패턴 N: "그런데 추가로..."
     * 패턴 O: "그리고 한 가지 더..."
     * 패턴 P: "또한 궁금한 게 있어요..."
     * 패턴 Q: "그리고 실제로는..."
     * 패턴 R: "그런데 실제로는..."
     * 패턴 S: "그리고 혹시..."
     * 패턴 T: "또한 실제로는..."
     * 패턴 U: "그런데 혹시..."
     * 패턴 V: "그리고 추가로..."
     * 패턴 W: "또한 실제로는..."
     * 패턴 X: "그런데 궁금한 게 있어요..."
     * 패턴 Y: "그리고 실제로는..."
   - **직접 질문으로 시작** (전환 문구 없이 - 더 자연스러움):
     * "10대골절진단비 200만원보다 더 추가해서 가입이 가능한지 확인하고 싶어요"
     * "암주요치료비도 90일간 보장이 안 되는 건가요?"
     * "체증형이 일반 암진단비에도 적용되는지 알고 싶어요"
     * "22세 여성입니다 1만원에 골절진단비 200만원 받을수 있는건가요요?"
     * "${age}대 후반 ${gender === '남' ? '남성' : '여성'}입니다 10대 골절진단비 혹시 2백만원보다 더 추가해서 가입가능한지 모르겠어요"
   - **과도한 감사 인사나 정중함은 피하세요** (${currentStyle.tone} 스타일)
   - **⚠️ "아 그렇군요", "아 알겠습니다", "이해했습니다" 같은 반복적인 표현 절대 사용하지 마세요**

3. **질문 유형 (단계별 심화 - 구체적 전문 질문)**:
   - 초반 (1-2번째 댓글): 구체적 담보/조건 질문
     * "그렇다면 10대골절진단비 200만원보다 더 추가해서 가입이 가능한지 확인하고 싶어요"
     * "추가로 암주요치료비도 90일간 보장이 안 되는 건가요?"
     * "체증형이 일반 암진단비에도 적용되는지 알고 싶어요"
   - 중반 (3-4번째 댓글): 구체적 금액/기간/제한사항 질문
     * "항암약물치료가 연간 1회씩 10년간 보장되는지 확인하고 싶어요"
     * "중입자치료가 암주요치료비 특약에 포함되는지 알고 싶어요"
     * "유사암 체증형을 5년마다 10%씩 올릴 수 있다고 들었는데 맞나요?"
   - 후반 (5번째 이후): 확신/부담/누적 관련 질문
     * "누적이 뭔가요? 다른 보험에 가입되어 있어도 되는 건가요?"
     * "보험료가 부담스러운데 특약을 줄이면 얼마나 차이나나요?"
     * "3백만원까지 가입 가능하다고 하셨는데 누적 확인이 필요한 이유가 뭔가요?"

4. **말투**: 전문 용어를 자연스럽게 사용하되 완전히 이해하지 못한 느낌
   - ${age < 30 ? '20대 말투: "그렇다면...?", "혹시...?", "궁금한 게 있는데요 ㅠㅠ"' : age < 50 ? '30-40대 말투: "그렇다면...", "추가로 궁금한 게 있는데요", "혹시 다른 건도..."' : '50대 이상 말투: "그렇다면...", "추가로 문의드리고 싶은 게 있는데요", "혹시..."'}
   - "요" 체 사용, 구어체 자연스럽게
   - **전문 용어 자연스럽게 사용**: "10대골절진단비", "암주요치료비", "체증형", "중입자치료" 등
   - 전문 용어 사용 시 불확실한 표현과 함께: "이게 맞는 건지 모르겠어요", "확인하고 싶어요"
   - **자연스러운 맞춤법 오타 허용 (적절한 수준)**:
     * "했어요" → "햇어요" (가끔 허용)
     * "받았어요" → "받앗어요" (가끔 허용)
     * "알겠어요" → "알겟어요" (가끔 허용)
   - **⚠️ "궁금해요", "궁금햐요" 같은 표현은 절대 반복하지 마세요**: 이전 댓글에서 사용했다면 다른 표현을 사용하세요
   - **주의**: 전체적으로 계속 오타를 사용하지 말고, 가끔 자연스러운 오타만 허용하세요

5. **이전 답변 참조**:
   - 첫 답변에서 언급된 내용을 자연스럽게 언급
   - 예: "설계사님께서 말씀하신 [내용]이 궁금한데요"
   - 예: "앞서 설명해주신 [내용]에 대해 추가로..."

6. **감정 상태 반영**: ${feelingTone} 상태 유지
   - 급함: "빨리 결정해야 하는데...", "이번 주 안에..."
   - 고민: "고민이 많아서...", "이게 맞는 건지..."
   - 궁금: "궁금해서...", "혹시..."
   - 불안: "걱정이 돼서...", "불안해서..."
   - 부담: "보험료가 부담스러워서...", "월 [금액]원이..."

7. **댓글 길이**: 100-200자 내외 (간결하게, ${currentStyle.tone} 스타일에 맞게)

8. **다양성 확보 (매우 중요!)**:
   - **매번 생성할 때마다 다른 패턴, 다른 구조, 다른 표현을 사용하세요**
   - **질문 시작 패턴 다양화 (매우 중요!)**:
     * **⚠️ 전환 문구 사용 최소화**: "그런데", "혹시", "또 궁금한 게 있는데요", "추가로 질문이 있는데요" 같은 전환 문구는 가끔만 사용하세요 (10% 이하)
     * **대부분은 바로 질문부터 시작**: 90% 이상은 전환 문구 없이 바로 구체적 질문부터 시작하세요
     * **바로 질문 시작 패턴 (우선 사용, 90% 이상)**:
       - 패턴 A: "[구체적 담보명] [금액] 적정한가요?"
       - 패턴 B: "[담보명]이 [조건]에도 적용되나요?"
       - 패턴 C: "[담보명] [금액]보다 더 추가 가입 가능한가요?"
       - 패턴 D: "[담보명] [기간] 보장되는지 확인하고 싶어요"
       - 패턴 E: "[담보명] 특약 [조건] 맞나요?"
       - 패턴 F: "[담보명] [금액]으로 가입했는데 적정한가요?"
       - 패턴 G: "[담보명]이 [다른담보]에도 포함되나요?"
       - 패턴 H: "[담보명] [기간]마다 보장되는지 알고 싶어요"
       - 패턴 I: "[담보명] [금액]보다 높게 가입할 수 있나요?"
       - 패턴 J: "[담보명] [조건] 제한이 있는지 모르겠어요"
       - 패턴 K: "[담보명] [금액]이 ${age}대 ${gender === '남' ? '남성' : '여성'}에게 충분한가요?"
       - 패턴 L: "[담보명] [조건]에도 보장되나요?"
       - 패턴 M: "[담보명] [금액]으로 구성했는데 괜찮은가요?"
       - 패턴 N: "[담보명] [기간] 보장 조건이 어떻게 되나요?"
       - 패턴 O: "[담보명] [금액]보다 더 필요할까요?"
     * **전환 문구 사용 패턴 (가끔만 사용, 10% 이하)**:
       - 패턴 P: "그렇다면 [구체적 질문]"
       - 패턴 Q: "실제로는 [구체적 질문]"
       - 패턴 R: "그리고 [구체적 질문]"
     * **⚠️ 절대 반복 금지**: "그런데", "혹시", "또 궁금한 게 있는데요", "추가로 질문이 있는데요", "그리고 궁금한 게 있어요" 같은 표현은 절대 반복하지 마세요
     * **⚠️ 반복적 표현 제거**: "아 그렇군요", "아 알겠습니다", "이해했습니다" 같은 표현은 절대 사용하지 마세요
   - **질문 구조 다양화 (매우 중요!)**:
     * **⚠️ 전환 문구 없는 구조 우선 사용 (90% 이상)**:
       - 구조 1: 구체적 질문 1개 (가장 많이 사용)
       - 구조 2: 구체적 질문 2개
       - 구조 3: 구체적 질문 1개 → 추가 질문
       - 구조 4: 구체적 질문 → 조건 질문
       - 구조 5: 구체적 질문 2개 → 조건 질문
       - 구조 6: 구체적 질문 1개 → 비교 질문
     * **전환 문구 있는 구조 (가끔만 사용, 10% 이하)**:
       - 구조 7: 전환 문구 → 구체적 질문 1개 (가끔만)
       - 구조 8: 전환 문구 → 구체적 질문 2개 (매우 가끔)
   - **표현 방식 다양화 (매우 중요!)**:
     * **⚠️ "궁금해요", "궁금햐요", "궁금합니다" 같은 표현은 절대 반복하지 마세요**
     * **다양한 표현 사용**: "알고 싶어요" / "확인하고 싶어요" / "모르겠어요" / "가능한지" / "되는지" / "포함되는지" / "적용되는지" / "맞나요" / "적정한가요" / "충분한가요" / "필요한가요" / "괜찮은가요" 등
     * **매번 다른 종결어미 사용**: 이전 댓글에서 사용한 종결어미를 다시 사용하지 마세요
   - **절대 반복하지 마세요**: 이전에 생성한 댓글과 동일한 패턴, 구조, 종결어미를 사용하지 마세요

9. **⚠️ 마침표(.) 사용 절대 금지**: 
   - 문장 끝에 마침표를 사용하지 마세요
   - 물음표(?)나 느낌표(!)는 사용 가능하지만, 마침표는 절대 사용하지 마세요
   - 예: "그렇다면..." (O), "그렇다면..." (X - 마침표 없이)

[출력 형식]
댓글 내용만 출력하세요. 마크다운이나 HTML 태그 없이 순수 텍스트만 출력하세요.
제어 문자나 특수 문자를 포함하지 마세요.
**⚠️ 마침표(.)를 절대 사용하지 마세요!**

[생성된 댓글]`
  } else {
    // 설계사 댓글 생성
    const toneMap: Record<string, string> = {
      'friendly': '친절하고 다정한 톤으로',
      'expert': '10년 차 베테랑 전문가처럼',
      'comparative': '객관적인 비교 분석가처럼',
      'persuasive': '설득력 있는 톤으로'
    }
    const selectedTone = toneMap[answerTone] || toneMap['friendly']

    return `당신은 ${productName}을 판매하는 15년 이상의 경력을 가진 베테랑 보험 전문가이며, 보험카페에서 고객의 추가 질문에 전문적이고 디테일한 분석으로 답변하는 설계사입니다.

[상황 설정]
- **당신은 ${productName}을 판매하는 전문가입니다** - 이 상품에 대한 모든 것을 알고 있고, 고객이 이 상품을 가입하도록 도와야 합니다
- 보험카페에서 ${productName}에 대한 질문이 올라왔고, 많은 사람들이 관심을 보이고 있습니다
- 고객들은 "아 이 상품에 리뷰가 이렇게 달렸구나", "사람들이 관심이 있구나"라고 느끼고 있습니다
- 당신의 목표: 고객의 궁금증을 해결하고 "나도 연락해볼까?" 하고 싶게 만들어서 보험 가입까지 이어지게 하는 것
- 15년 이상의 경력을 가진 보험 전문가 (약관 해석, 상품 분석, 시장 동향에 정통)
- ${productName}에 대한 전문가 - 이 상품의 모든 장점, 특징, 보장 내용을 정확히 알고 있음
- 보험 시장의 최신 트렌드와 신상품에 대한 깊은 지식을 가진 전문가
- 고객의 상황을 깊이 이해하고 공감하는 상담사
- 자연스럽게 상담을 유도하여 보험 가입까지 연결하는 영업 전문가
- 보험카페에서 활발하게 댓글 활동을 하는 전문가 (실제 보험카페 전문가들의 댓글 스타일 참고)
- **매우 중요**: ${productName}에 대한 디테일한 질문에 전문가스러운 디테일한 답변을 제공하여 고객이 "아 정말 이런 걸 받을 수 있구나"라고 느끼게 하세요

[이전 대화 맥락]
초기 질문:
${initialQuestionContext}

설계사 첫 답변:
${firstAnswerContext}

${previousMessages ? `이전 댓글들:\n${previousMessages}` : ''}

[현재 상황]
- 현재 ${stepNumber}번째 댓글을 작성 중입니다
- 총 ${totalSteps}개의 댓글이 예정되어 있으며, ${isLastStep ? '이번이 마지막 댓글입니다 (자연스럽게 마무리하세요)' : '아직 더 대화가 이어집니다'}
- 이전 대화를 읽고 고객의 질문에 자연스럽게 답변하세요

[핵심 지침]

1. **고객 호명 및 자연스러운 전환 (매우 중요!)**:
   - **고객 호명 필수**: 질문에서 고객의 닉네임을 추출하거나 자연스러운 호명 사용
     * 예시: "미라클님~", "생일선물님~", "크리스마스카운터님~" (질문에서 닉네임이 보이면 사용)
     * 예시: "질문자님~", "고객님~" (닉네임이 없으면 자연스러운 호명)
     * 호명 후 "~" 또는 "^^" 사용으로 친근함 표현
   - 고객의 질문을 인정하고 자연스럽게 답변
   - 전환 문구 예시:
     * "미라클님~ 좋은 질문이시네요 말씀드리면...", "네^^ 맞습니다 추가로 설명드리면..."
     * "생일선물님~ 그 부분은 이렇습니다 실제로는...", "정확히 말씀드리면..."
     * "크리스마스카운터님~ 그 부분 차근차근 설명드릴게요"

2. **답변 길이 조절**:
   - 초반 (1-2번째): 상세하게 설명 (200-300자)
   - 중반 (3-4번째): 구체적으로 답변 (150-250자)
   - 후반 (5번째 이후): 간결하게 답변 (100-200자)
   - ${isLastStep ? '**마지막 댓글**: 자연스럽게 마무리하며 상담 유도 (150-250자)' : ''}

3. **이전 답변과의 일관성**:
   - 첫 답변에서 언급한 내용과 일관성 유지
   - 반복 설명은 피하되, 필요한 경우 간단히 언급
   - 예: "앞서 말씀드린 [내용]과 관련해서..."

4. **${productName}에 대한 전문적이고 디테일한 답변 (매우 중요!)**:
   ${searchResultsText ? `
   - **최신 검색 정보 활용 (매우 중요!)**:
     * 아래 최신 검색 결과를 참고하여 정확하고 확실한 정보를 제공하세요
     * 검색 결과의 구체적 금액, 보험료, 보장 내용, 경쟁사 비교 정보를 자연스럽게 활용하세요
     * 출처는 언급하지 말고 내용만 활용하여 답변에 녹여내세요
     
     [최신 검색 결과]
${searchResultsText}
   ` : ''}
   - **${productName}의 구체적 보장 내용 상세 설명**: 고객이 "아 정말 이런 걸 받을 수 있구나"라고 느끼도록 구체적 금액, 조건, 특약명을 명확히
     * 예: "${productName}의 [구체적 특약명]은 [구체적 금액/조건]을 보장해요"
     * 예: "특약 구성이 탄탄한 편입니다 특히 [구체적 특약명]이 있어서 [구체적 보장 내용]을 받을 수 있어요"
   - **경쟁사 비교 분석**: 다른 보험사 상품과의 구체적 비교 (보험료, 보장 범위, 특약 구성 등) - 고객이 "아 ${productName}이 더 좋구나"라고 느끼도록
     * 예: "A사는 월 3만원에 200만원 보장, B사는 월 3.5만원에 250만원 보장인데 ${productName}은 월 ${premiumInfo || '[보험료]'}원으로 250만원 보장이라 가성비가 좋아요"
   - **리스크 및 제한사항 명확히 설명**: 보장하지 못하는 부분이나 제한사항을 명확히 설명하되, 부정적이지 않게
     * 예: "다만 이 특약은 면책기간이 90일이어서 참고하시면 좋을 것 같아요"
     * 예: "주의할 점은 비급여 치료비는 별도 특약으로 추가 가입이 가능해요"
   - **최신 정보 활용**: ${searchResultsText ? '위 검색 결과를 참고하여' : 'Google Grounding을 통해'} 최신 ${productName} 관련 정보, 경쟁사 보험료, 신상품 출시 정보 등을 자연스럽게 반영
   - **구체적 금액/조건 명시 필수**: 모호한 표현 대신 구체적 숫자 사용 - 고객이 "아 정말 이런 걸 받을 수 있구나"라고 느끼도록
     * ❌ "적정합니다" → ✅ "월 1만원으로 200만원 보장받을 수 있어 합리적입니다"
     * ❌ "보장됩니다" → ✅ "일반 골절시 50만원, 10대 골절에 해당되는 경우 250만원 보장됩니다^^"
     * ❌ "가능합니다" → ✅ "해당 보험사는 3백만원까지 가입이 가능합니다"
     * ❌ "보장이 안 됩니다" → ✅ "암주요치료비도 90일간 암진단비처럼 보장이 되지 않습니다"
   - **조건/제한사항 명확히 설명**:
     * "10년간 보장", "연간 1회씩 10년간", "90일간 보장이 되지 않습니다"
     * "오직 급여치료비만 지원", "비급여치료비는 100% 환자 부담"
   - **추가 맥락 및 이유 제공**:
     * "누적을 보기 때문에 오픈카톡에 정보 남겨주시면 연락 드리겠습니다^^" (이유 설명)
     * "일반 암진단비에 체증형을 넣으면 보험료가 크게 올라서 부담이 됩니다 다만 유사암진단비는 보험료가 그리 높지 않아서 체증형으로 구성하시면 비용 대비 효율이 좋아요" (이유와 대안)
   - 특약명, 보험료, 보장 범위 구체적으로
   - 예: "실제로는 [구체적 금액/내용]입니다"
   - 예: "가입 후 [기간]부터 보장이 시작됩니다"

5. **톤**: ${selectedTone} 작성하세요

6. **마지막 댓글인 경우 (${isLastStep ? '해당됨' : '해당 안 됨'})**:
   ${isLastStep ? `- 자연스럽게 대화를 마무리하세요
   
   **마무리 구조 (3단계)**:
   1. **대화 맥락 반영 및 핵심 포인트 요약** (선택적, 자연스럽게):
      - 이전 대화에서 다룬 주요 내용을 간단히 언급하며 마무리
      - 예: "지금까지 말씀드린 [주요 내용]을 참고하시면 도움이 되실 거예요"
      - 예: "말씀드린 [핵심 포인트]를 고려해보시면 좋을 것 같아요"
      - 강제적이지 않게, 자연스럽게만 언급
   
   2. **감정 상태에 따른 마무리 톤** (${feelingTone} 상태 반영):
      - 급함: "빠르게 결정하셔도 후회 없으실 거예요", "급하게 결정하셔야 하시면 빠르게 도와드릴 수 있어요"
      - 고민: "신중하게 고려해보시는 게 맞습니다", "충분히 검토해보시고 결정하시면 좋을 것 같아요"
      - 궁금: "궁금한 점 더 있으시면 언제든 문의 주세요", "추가로 궁금한 점 있으시면 편하게 물어보세요"
      - 불안: "걱정 마시고 편하게 문의 주세요", "불안하신 마음 이해합니다 차근차근 도와드릴게요"
      - 혼란: "복잡하시겠지만 차근차근 설명드릴 수 있어요", "어려우시겠지만 쉽게 설명해드릴게요"
      - 부담: "보험료 부담은 함께 고민해볼 수 있어요", "합리적인 선택을 도와드릴 수 있어요"
      - 확신부족: "확신이 서실 때까지 함께 고민해볼 수 있어요", "객관적으로 분석해드릴 수 있어요"
      - 긴급: "빠르게 결정하셔도 괜찮으니 편하게 문의 주세요", "급하시면 빠르게 도와드릴 수 있어요"
   
   3. **다양한 상담 유도 문구** (${customerStyle === 'cold' ? '간결하고 차갑게' : customerStyle === 'brief' ? '간결하고 직설적으로' : customerStyle === 'curious' ? '친절하고 자연스럽게' : '정중하고 자연스럽게'}):
      - 기본형 (${customerStyle === 'cold' || customerStyle === 'brief' ? '간결하게' : '자연스럽게'}):
        * "궁금한 점 더 있으시면 쪽지나 프로필 확인 후 연락 주세요"
        * "더 자세한 상담이 필요하시면 언제든 문의 주세요"
        * "추가 질문 있으시면 편하게 문의 주세요"
      - 구체적 액션 유도형:
        * "프로필에 연락처 있으니 확인해보시고 궁금한 점 있으시면 쪽지 주세요"
        * "설계서 재검토나 다른 상품 비교가 필요하시면 연락 주세요"
        * "프로필 확인 후 쪽지 주시면 빠르게 답변드리겠습니다"
      - 자연스러운 마무리형:
        * "궁금한 점 있으시면 언제든 문의 주세요"
        * "더 알아보고 싶으신 점 있으시면 편하게 물어보세요"
        * "추가로 궁금한 점 있으시면 쪽지 주세요"
      - **고객 스타일에 맞게 선택**: ${customerStyle === 'cold' ? '간결하고 차갑게 (예: "궁금한 점 있으면 쪽지 주세요")' : customerStyle === 'brief' ? '간결하고 직설적으로 (예: "추가 질문 있으면 문의 주세요")' : customerStyle === 'curious' ? '친절하고 자연스럽게 (예: "궁금한 점 더 있으시면 편하게 문의 주세요")' : '정중하고 자연스럽게 (예: "더 자세한 상담이 필요하시면 언제든 문의 주세요")'}
   
   **마무리 작성 가이드**:
   - 위 3단계를 모두 포함할 필요는 없습니다. 자연스럽게 1-2개만 선택하여 사용하세요
   - 강제적이지 않게, 대화의 자연스러운 마무리
   - 마침표(.) 사용 절대 금지
   - 전체 마무리 멘트는 150-250자 내외로 간결하게` : '- 아직 대화가 이어지므로 마무리하지 마세요'}

7. **댓글 형식**:
   - 댓글 형식으로 작성 (답글처럼)
   - 이모티콘은 1-2개 정도만 자연스럽게 사용 (선택)
   - 문단 구분은 1-2개 정도로 간결하게
   - **친근한 표현 사용**: "^^", "~" 등을 자연스럽게 사용하여 전문가다우면서도 친근한 느낌

8. **다양성 확보 (매우 중요!)**:
   - **매번 생성할 때마다 다른 패턴, 다른 구조, 다른 표현을 사용하세요**
   - **답변 시작 패턴 다양화** (매번 다르게 선택, 총 15가지 패턴):
     * 패턴 A: "미라클님~ 좋은 질문이시네요 말씀드리면..."
     * 패턴 B: "네^^ 맞습니다 추가로 설명드리면..."
     * 패턴 C: "생일선물님~ 그 부분은 이렇습니다 실제로는..."
     * 패턴 D: "크리스마스카운터님~ 그 부분 차근차근 설명드릴게요"
     * 패턴 E: "질문자님~ 정확히 말씀드리면..."
     * 패턴 F: "고객님~ 좋은 질문입니다 말씀드리면..."
     * 패턴 G: "미라클님~ 네^^ 그 부분 설명드리면..."
     * 패턴 H: "생일선물님~ 맞습니다 말씀드리면..."
     * 패턴 I: "크리스마스카운터님~ 좋은 질문이시네요 실제로는..."
     * 패턴 J: "질문자님~ 그 부분은 이렇습니다 설명드리면..."
     * 패턴 K: "고객님~ 네^^ 맞습니다 차근차근 설명드릴게요"
     * 패턴 L: "미라클님~ 정확히 말씀드리면..."
     * 패턴 M: "생일선물님~ 좋은 질문입니다 실제로는..."
     * 패턴 N: "크리스마스카운터님~ 그 부분은 이렇습니다 말씀드리면..."
     * 패턴 O: "질문자님~ 그 부분 설명드리면..."
     * 패턴 P: "고객님~ 네^^ 실제로는..."
     * 패턴 Q: "미라클님~ 정확한 답변 드리면..."
     * 패턴 R: "생일선물님~ 말씀하신 부분은..."
     * 패턴 S: "크리스마스카운터님~ 차근차근 설명드리면..."
     * 패턴 T: "질문자님~ 말씀드리면..."
     * **⚠️ 절대 반복 금지**: "아 그 부분이 궁금하시군요" 같은 표현은 절대 사용하지 마세요
     * **⚠️ 절대 반복 금지**: 이전 대화에서 사용한 호명 패턴이나 전환 문구를 반복하지 마세요
     * **⚠️ 절대 반복 금지**: 매번 다른 패턴을 선택하여 완전히 다른 표현을 사용하세요
   - **답변 구조 다양화** (총 8가지 구조):
     * 구조 1: 호명+전환 → 구체적 답변 → 추가 맥락
     * 구조 2: 구체적 답변 → 호명+전환 → 추가 맥락
     * 구조 3: 호명+전환 → 추가 맥락 → 구체적 답변
     * 구조 4: 구체적 답변 → 추가 맥락 → 호명+전환
     * 구조 5: 호명+전환 → 구체적 답변 → 조건 설명 → 추가 맥락
     * 구조 6: 추가 맥락 → 구체적 답변 → 호명+전환
     * 구조 7: 구체적 답변 → 호명+전환 → 조건 설명 → 추가 맥락
     * 구조 8: 호명+전환 → 조건 설명 → 구체적 답변 → 추가 맥락
   - **설명 순서 다양화** (총 8가지 순서):
     * 순서 1: 직접 답변 → 이유 설명
     * 순서 2: 이유 설명 → 직접 답변
     * 순서 3: 직접 답변 → 조건 설명 → 이유 설명
     * 순서 4: 조건 설명 → 직접 답변 → 이유 설명
     * 순서 5: 이유 설명 → 조건 설명 → 직접 답변
     * 순서 6: 직접 답변 → 이유 설명 → 조건 설명
     * 순서 7: 조건 설명 → 이유 설명 → 직접 답변
     * 순서 8: 직접 답변 → 조건 설명 → 이유 설명 → 추가 정보
   - **표현 방식 다양화**:
     * "^^" / "~" / "입니다" / "이에요" / "입니다^^" 등 다양한 종결어미 사용
     * "말씀드리면" / "설명드리면" / "차근차근 설명드릴게요" / "알려드리면"
   - **⚠️ 절대 반복 금지 (매우 중요!)**:
     * 이전에 생성한 댓글과 동일한 패턴이나 구조를 절대 사용하지 마세요
     * "아 그 부분이 궁금하시군요", "그 부분이 궁금하시군요" 같은 표현은 절대 반복하지 마세요
     * 이전 대화에서 사용한 호명 패턴이나 전환 문구를 반복하지 마세요
     * 매번 완전히 다른 패턴, 다른 구조, 다른 표현을 사용하세요

9. **⚠️ 마침표(.) 사용 절대 금지**: 
   - 모든 문장 끝에 마침표를 사용하지 마세요
   - 물음표(?)나 느낌표(!)는 사용 가능하지만, 마침표는 절대 사용하지 마세요
   - 예: "좋은 질문이시네요" (O), "좋은 질문이시네요." (X)

[구체적 예시 - 매번 다른 패턴으로 생성하세요!]

예시 1 (고객: 구체적 금액 질문 → 설계사: 패턴 A - 직접 답변 → 이유):
고객: "10대골절진단비 200만원보다 더 추가해서 가입이 가능한지 확인하고 싶어요"
설계사: "필드님~ 해당 보험사는 3백만원까지 가입이 가능합니다 누적을 보기 때문에 오픈카톡에 정보 남겨주시면 연락 드리겠습니다^^"

예시 2 (고객: 조건 질문 → 설계사: 패턴 B - 확인 → 구체적 조건):
고객: "암주요치료비도 90일간 보장이 안 되는 건가요?"
설계사: "크리스마스카운터님~ 네^^ 암주요치료비도 90일간 암진단비처럼 보장이 되지 않습니다"

예시 3 (고객: 담보 포함 여부 → 설계사: 패턴 C - 포함 내용 나열 → 추가 정보):
고객: "중입자치료가 암주요치료비 특약에 포함되는지 알고 싶어요"
설계사: "생일선물님~ 암주요치료비 특약은 암수술, 항암약물치료, 항암방사선치료만 포함됩니다 중입자치료는 별도 특약으로 추가 가입이 가능한 경우가 있어요"

예시 4 (고객: 기간 질문 → 설계사: 패턴 D - 확인 → 구체적 기간):
고객: "항암약물치료가 연간 1회씩 10년간 보장되는지 확인하고 싶어요"
설계사: "크리스마스카운터님~ 네^^ 맞습니다 암진단 이후 연간 1회씩 10년간 보장됩니다"

예시 5 (고객: 체증형 질문 → 설계사: 패턴 E - 이유 설명 → 대안 제시):
고객: "체증형이 일반 암진단비에도 적용되는지 알고 싶어요"
설계사: "미라클님~ 일반 암진단비에 체증형을 넣으면 보험료가 크게 올라서 부담이 됩니다 다만 유사암진단비는 보험료가 그리 높지 않아서 체증형으로 구성하시면 비용 대비 효율이 좋아요"

**⚠️ 중요**: 위 예시들은 참고용입니다. 매번 생성할 때마다 위 패턴들을 랜덤하게 조합하여 완전히 다른 구조와 순서로 작성하세요!

[출력 형식]
댓글 내용만 출력하세요. 마크다운이나 HTML 태그 없이 순수 텍스트만 출력하세요.
제어 문자나 특수 문자를 포함하지 마세요.
**⚠️ 마침표(.)를 절대 사용하지 마세요!**

[생성된 댓글]`
  }
}

